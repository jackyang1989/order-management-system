# 联系客服功能改版测试指南

## 📋 改版概述

本次改版将联系客服功能从"所有订单使用相同内容"升级为"每单独立配置问题，支持连续提问"。

### 核心改进
- ✅ 商家可设置需要联系客服的订单数量（默认等于任务总数）
- ✅ 每单可配置独立的问题列表
- ✅ 支持每单多个连续提问（点击+号添加）
- ✅ 系统自动随机分配问题给买家
- ✅ 完全兼容旧版数据

---

## 🗄️ 数据库迁移

### 1. 运行迁移脚本

```bash
cd backend
npm run typeorm migration:generate -- -n AddContactCSConfig
npm run typeorm migration:run
```

### 2. 验证字段添加

检查数据库表是否添加了新字段：

**tasks 表：**
- `contactCSConfig` (jsonb, nullable)

**orders 表：**
- `needContactCS` (boolean, default: false)
- `contactCSQuestions` (jsonb, nullable)

---

## 🧪 测试场景

### 场景1：商家发布新任务（新版功能）

#### 测试步骤：
1. 登录商家账号
2. 进入"发布任务"页面
3. 填写基本信息（第一步）
4. 进入"增值服务配置"（第二步）
5. 找到"联系客服设置"section

#### 验证点：
- [ ] 看到"联系客服设置"独立section（在好评设置之后）
- [ ] 有开关可以启用/禁用联系客服
- [ ] 启用后显示"需要联系客服的订单数量"输入框
- [ ] 默认数量等于任务总数
- [ ] 可以修改数量（不能超过任务总数）

#### 配置测试：
**测试用例1：发布5单任务，3单需要联系客服**

1. 设置任务数量为5
2. 启用联系客服
3. 设置需要联系客服的订单数量为3
4. 为第1单配置：
   - 问题1："请问这个商品有现货吗？"
   - 点击+号添加问题2："发货需要几天？"
5. 为第2单配置：
   - 问题1："请问支持7天无理由退货吗？"
6. 为第3单配置：
   - 问题1："请问有什么优惠活动吗？"
   - 点击+号添加问题2："可以使用优惠券吗？"
   - 点击+号添加问题3："满多少包邮？"

**验证点：**
- [ ] 显示3个订单配置卡片（第1单、第2单、第3单）
- [ ] 每个卡片有独立的问题输入框
- [ ] 最后一个问题右侧有+号按钮
- [ ] 点击+号可以添加新问题
- [ ] 有多个问题时，每个问题右侧有×号可以删除
- [ ] 至少保留1个问题（最后一个问题不能删除）
- [ ] 提交任务成功

---

### 场景2：买家接单并查看问题

#### 测试步骤：
1. 使用5个不同的买家账号接单
2. 每个买家进入"任务执行"页面

#### 验证点：
**买家1-3（需要联系客服）：**
- [ ] 顶部显示"必须联系客服"提示框
- [ ] 提示框中显示该订单的所有问题（编号显示）
- [ ] 商品信息核对区域也显示联系客服要求
- [ ] 问题格式：
  ```
  问题1：[内容]
  问题2：[内容]
  ```

**买家4-5（不需要联系客服）：**
- [ ] 不显示"必须联系客服"提示框
- [ ] 商品信息核对区域不显示联系客服要求

**随机分配验证：**
- [ ] 3个需要联系客服的买家看到的问题各不相同
- [ ] 每个买家看到的问题与商家配置的某一单完全匹配

---

### 场景3：商家查看任务详情

#### 测试步骤：
1. 登录商家账号
2. 进入"任务管理"
3. 点击查看任务详情

#### 验证点：
- [ ] 浏览行为设置中显示"联系客服: 3单需要"
- [ ] 页面下方有"联系客服配置"section
- [ ] 显示3个订单配置卡片
- [ ] 每个卡片显示：
  - 订单编号（第X单）
  - 问题数量badge（如"2个问题"）
  - 所有问题列表

---

### 场景4：商家审核订单

#### 测试步骤：
1. 买家提交订单（包含聊天截图）
2. 商家进入"订单审核"
3. 查看订单详情

#### 验证点：
- [ ] 订单详情中显示"联系客服要求"
- [ ] 显示该订单分配到的所有问题
- [ ] 问题格式正确（问题1、问题2...）
- [ ] 可以查看买家上传的聊天截图

---

### 场景5：管理后台查看

#### 测试步骤：
1. 登录管理员账号
2. 查看任务详情和订单详情

#### 验证点：
**任务详情：**
- [ ] 显示完整的联系客服配置
- [ ] 显示每单的问题列表

**订单详情：**
- [ ] 显示该订单的联系客服问题
- [ ] 格式正确

---

### 场景6：旧数据兼容性测试

#### 测试步骤：
1. 查看旧版本创建的任务（只有contactCSContent字段）
2. 查看旧版本的订单

#### 验证点：
- [ ] 任务详情正确显示旧版联系客服内容
- [ ] 订单详情正确显示旧版联系客服内容
- [ ] 买家任务执行页面正确显示旧版内容
- [ ] 不会出现错误或空白

---

## 🐛 常见问题排查

### 问题1：商家发布任务时看不到"联系客服设置"
**排查步骤：**
1. 检查前端代码是否正确部署
2. 清除浏览器缓存
3. 检查 [Step2ValueAdded.tsx](frontend/src/app/merchant/tasks/new/_components/Step2ValueAdded.tsx) 是否正确修改

### 问题2：买家接单后看不到问题
**排查步骤：**
1. 检查订单是否成功创建
2. 查看数据库 orders 表的 `needContactCS` 和 `contactCSQuestions` 字段
3. 检查 [orders.service.ts:459-486](backend/src/orders/orders.service.ts#L459-L486) 的分配逻辑
4. 检查前端 [execute/page.tsx](frontend/src/app/orders/[id]/execute/page.tsx) 是否正确获取数据

### 问题3：问题分配不正确
**排查步骤：**
1. 检查任务的 `contactCSConfig` 字段格式是否正确
2. 检查订单创建时的 `claimedCount` 是否正确
3. 查看后端日志，确认分配逻辑执行情况

### 问题4：旧数据显示异常
**排查步骤：**
1. 检查是否有兼容性判断逻辑
2. 确认旧数据的 `contactCSContent` 字段是否存在
3. 检查前端是否正确处理 undefined/null 值

---

## 📊 测试数据示例

### 新版任务配置数据
```json
{
  "contactCSConfig": {
    "enabled": true,
    "count": 3,
    "questions": [
      {
        "id": "cs-1234567890-0",
        "questions": [
          "请问这个商品有现货吗？",
          "发货需要几天？"
        ]
      },
      {
        "id": "cs-1234567890-1",
        "questions": [
          "请问支持7天无理由退货吗？"
        ]
      },
      {
        "id": "cs-1234567890-2",
        "questions": [
          "请问有什么优惠活动吗？",
          "可以使用优惠券吗？",
          "满多少包邮？"
        ]
      }
    ]
  }
}
```

### 订单分配结果数据
```json
{
  "needContactCS": true,
  "contactCSQuestions": [
    "请问这个商品有现货吗？",
    "发货需要几天？"
  ]
}
```

---

## ✅ 测试检查清单

### 功能测试
- [ ] 商家可以启用/禁用联系客服
- [ ] 商家可以设置需要联系客服的订单数量
- [ ] 商家可以为每单配置独立问题
- [ ] 商家可以为每单添加多个问题
- [ ] 商家可以删除问题（保留至少1个）
- [ ] 买家接单后看到正确的问题
- [ ] 问题随机分配不重复
- [ ] 不需要联系客服的订单不显示相关内容

### 界面测试
- [ ] 商家发布任务页面UI正确
- [ ] 买家任务执行页面UI正确
- [ ] 商家任务详情页UI正确
- [ ] 商家订单审核页UI正确
- [ ] 管理后台任务详情页UI正确
- [ ] 管理后台订单详情页UI正确

### 兼容性测试
- [ ] 旧版任务正确显示
- [ ] 旧版订单正确显示
- [ ] 新旧数据混合场景正常工作

### 性能测试
- [ ] 发布大量订单的任务（如100单）响应正常
- [ ] 页面加载速度正常
- [ ] 数据库查询性能正常

---

## 🚀 上线建议

### 上线前检查
1. ✅ 所有测试场景通过
2. ✅ 数据库迁移脚本准备就绪
3. ✅ 前后端代码已部署到测试环境
4. ✅ 测试环境验证通过
5. ✅ 准备回滚方案

### 上线步骤
1. 备份生产数据库
2. 执行数据库迁移
3. 部署后端代码
4. 部署前端代码
5. 验证核心功能
6. 监控错误日志

### 回滚方案
如果出现严重问题：
1. 回滚前端代码到旧版本
2. 回滚后端代码到旧版本
3. 数据库字段保留（不影响旧版功能）

---

## 📞 技术支持

如有问题，请联系开发团队或查看以下文档：
- 代码仓库：[order-management-system](.)
- 技术文档：查看各文件的注释
- 问题反馈：提交 Issue

---

**测试完成日期：** ___________

**测试人员签名：** ___________

**测试结果：** □ 通过  □ 不通过

**备注：** ___________________________________________
