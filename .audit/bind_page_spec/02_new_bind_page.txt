== [2] æ–°ç‰ˆï¼š/profile/bind é¡µé¢ä»£ç  ==
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { cn } from '../../../lib/utils';
import ProfileContainer from '../../../components/ProfileContainer';
import { Button } from '../../../components/ui/button';
import { Card } from '../../../components/ui/card';
import { Badge } from '../../../components/ui/badge';
import { fetchBuyerAccounts, addBuyerAccount } from '../../../services/userService';
import { MockBuyerAccount } from '../../../mocks/userMock';

export default function BindAccountPage() {
    const router = useRouter();
    const [activeTab, setActiveTab] = useState<'list' | 'add'>('list');
    const [accounts, setAccounts] = useState<MockBuyerAccount[]>([]);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);

    const [form, setForm] = useState({
        accountName: '',
        receiverPhone: '',
        platform: 'æ·˜å®' as 'æ·˜å®' | 'äº¬ä¸œ' | 'æ‹¼å¤šå¤š',
        province: '',
        city: '',
        fullAddress: '',
        receiverName: ''
    });

    useEffect(() => { loadAccounts(); }, []);

    const loadAccounts = async () => {
        setLoading(true);
        try { const list = await fetchBuyerAccounts(); setAccounts(list); }
        catch (e) { console.error('Load accounts error:', e); }
        finally { setLoading(false); }
    };

    const handleAdd = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!form.accountName || !form.receiverPhone || !form.fullAddress) { alert('è¯·å¡«å†™å¿…å¡«ä¿¡æ¯'); return; }
        setSubmitting(true);
        try {
            const res = await addBuyerAccount(form);
            if (res.success) { alert(res.message); setActiveTab('list'); loadAccounts(); setForm({ accountName: '', receiverPhone: '', platform: 'æ·˜å®', province: '', city: '', fullAddress: '', receiverName: '' }); }
            else { alert(res.message); }
        } catch (e) { alert('æäº¤å¤±è´¥'); }
        finally { setSubmitting(false); }
    };

    return (
        <div className="min-h-screen bg-slate-50 pb-20">
            {/* Header */}
            <header className="sticky top-0 z-10 border-b border-slate-200 bg-white">
                <div className="mx-auto flex h-14 max-w-[515px] items-center px-4">
                    <button onClick={() => router.back()} className="mr-4 text-slate-600">â†</button>
                    <h1 className="flex-1 text-base font-medium text-slate-800">ä¹°å·ç®¡ç†</h1>
                </div>
            </header>

            <ProfileContainer className="py-4">
                {/* Tabs */}
                <div className="mb-4 flex rounded-lg border border-slate-200 bg-white p-1 shadow-sm">
                    {[{ key: 'list', label: 'è´¦å·åˆ—è¡¨' }, { key: 'add', label: 'æ·»åŠ è´¦å·' }].map(tab => (
                        <button key={tab.key} onClick={() => setActiveTab(tab.key as any)}
                            className={cn('flex-1 rounded-md py-2 text-center text-sm font-medium transition-colors', activeTab === tab.key ? 'bg-blue-500 text-white' : 'text-slate-500')}>
                            {tab.label}
                        </button>
                    ))}
                </div>

                {activeTab === 'list' ? (
                    <div className="space-y-4">
                        {loading ? (
                            <div className="py-12 text-center text-slate-400">åŠ è½½ä¸­...</div>
                        ) : accounts.length === 0 ? (
                            <div className="rounded-xl border border-dashed border-slate-300 bg-white py-12 text-center text-slate-400">
                                <div className="mb-3 text-4xl">ğŸ›’</div>
                                <p className="text-sm">æš‚æœªç»‘å®šä¹°å·</p>
                                <Button className="mt-4 bg-blue-500" onClick={() => setActiveTab('add')}>ç«‹å³æ·»åŠ </Button>
                            </div>
                        ) : (
                            accounts.map(acc => (
                                <Card key={acc.id} className="border-slate-200 p-4 shadow-sm">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="flex h-10 w-10 items-center justify-center rounded-full bg-blue-50 text-xl font-bold text-blue-500">{(acc.accountName || '').charAt(0).toUpperCase()}</div>
                                            <div>
                                                <div className="font-bold text-slate-800">{acc.accountName}</div>
                                                <div className="text-xs text-slate-400">{acc.platform} Â· {acc.receiverPhone}</div>
                                            </div>
                                        </div>
                                        <Badge variant="soft" color={(acc.status === 'APPROVED' || acc.status === 1) ? 'green' : (acc.status === 'PENDING' || acc.status === 0) ? 'amber' : 'red'}>
                                            {(acc.status === 'APPROVED' || acc.status === 1) ? 'å·²é€šè¿‡' : (acc.status === 'PENDING' || acc.status === 0) ? 'å®¡æ ¸ä¸­' : 'æ‹’ç»'}
                                        </Badge>
                                    </div>
                                    <div className="mt-3 text-xs text-slate-500">æ”¶è´§åœ°å€: {acc.province}{acc.city}{acc.fullAddress}</div>
                                </Card>
                            ))
                        )}
                    </div>
                ) : (
                    <Card className="border-slate-200 p-5 shadow-sm">
                        <form onSubmit={handleAdd} className="space-y-4">
                            <div>
                                <label className="mb-1 block text-xs text-slate-500">é€‰æ‹©å¹³å° <span className="text-red-500">*</span></label>
                                <select className="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800" value={form.platform} onChange={e => setForm(f => ({ ...f, platform: e.target.value as any }))}>
                                    <option value="æ·˜å®">æ·˜å®</option>
                                    <option value="äº¬ä¸œ">äº¬ä¸œ</option>
                                    <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
                                </select>
                            </div>
                            <div>
                                <label className="mb-1 block text-xs text-slate-500">è´¦å·/æ—ºæ—ºID <span className="text-red-500">*</span></label>
                                <input className="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800" placeholder="è´¦å·ç”¨æˆ·å/ID" value={form.accountName} onChange={e => setForm(f => ({ ...f, accountName: e.target.value }))} />
                            </div>
                            <div>
                                <label className="mb-1 block text-xs text-slate-500">æ”¶è´§æ‰‹æœºå· <span className="text-red-500">*</span></label>
                                <input className="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800" placeholder="æ”¶è´§å…³è”æ‰‹æœºå·" value={form.receiverPhone} onChange={e => setForm(f => ({ ...f, receiverPhone: e.target.value }))} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="mb-1 block text-xs text-slate-500">çœä»½</label>
                                    <input className="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800" placeholder="çœä»½" value={form.province} onChange={e => setForm(f => ({ ...f, province: e.target.value }))} />
                                </div>
                                <div>
                                    <label className="mb-1 block text-xs text-slate-500">åŸå¸‚</label>
                                    <input className="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800" placeholder="åŸå¸‚" value={form.city} onChange={e => setForm(f => ({ ...f, city: e.target.value }))} />
                                </div>
                            </div>
                            <div>
                                <label className="mb-1 block text-xs text-slate-500">è¯¦ç»†æ”¶è´§åœ°å€ <span className="text-red-500">*</span></label>
                                <textarea className="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800" placeholder="æ”¶è´§è¯¦ç»†åœ°å€" rows={3} value={form.fullAddress} onChange={e => setForm(f => ({ ...f, fullAddress: e.target.value }))} />
                            </div>
                            <Button type="submit" loading={submitting} className="mt-2 w-full bg-blue-500 py-6 text-base font-medium hover:bg-blue-600">æäº¤ç”³è¯·</Button>
                        </form>
                    </Card>
                )}
            </ProfileContainer>
        </div>
    );
}
