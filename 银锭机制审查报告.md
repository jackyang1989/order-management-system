# é“¶é”­æœºåˆ¶å®¡æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-17
**å®¡æŸ¥èŒƒå›´**: åŸç‰ˆç³»ç»Ÿ vs é‡æ„ç‰ˆç³»ç»Ÿ
**å®¡æŸ¥äºº**: Claude Code

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### å…³é”®å‘ç°

1. âœ… **åŸç‰ˆç³»ç»Ÿè®¾è®¡åˆç†** - æœ‰å®Œå–„çš„é˜²èµ„æŸæœºåˆ¶
2. âš ï¸ **é‡æ„ç‰ˆå­˜åœ¨é…ç½®é—®é¢˜** - æ³¨å†Œèµ é€é“¶é”­åŠŸèƒ½å·²å®ç°ä½†å¯èƒ½é…ç½®æœªç”Ÿæ•ˆ
3. âœ… **ä¸¤ç‰ˆæœ¬é€»è¾‘åŸºæœ¬ä¸€è‡´** - æ ¸å¿ƒæœºåˆ¶å·²æ­£ç¡®è¿ç§»
4. ğŸ“Š **èµ„æŸé£é™©å·²æ§åˆ¶** - é€šè¿‡å–æ¶ˆæƒ©ç½šæœºåˆ¶å’Œæ¥å•æŠ¼é‡‘åˆ¶åº¦

---

## 1. åŸç‰ˆç³»ç»Ÿé“¶é”­æœºåˆ¶è¯¦è§£

### 1.1 æ³¨å†Œèµ é€æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/controller/Login.php:150-171`

```php
// ç¬¬150è¡Œï¼šä»åå°é…ç½®è¯»å–èµ é€æ•°é‡
'reward' => $admin_limit['user_num'],

// ç¬¬171è¡Œï¼šè®°å½•è´¢åŠ¡æµæ°´
finance($user_insert['id'], 2, 1, 2, 14, "é¦–æ¬¡æ³¨å†Œèµ é€1é“¶é”­");
```

**é…ç½®æ¥æº**:
- é…ç½®è¡¨ï¼š`tfkz_system`
- é…ç½®å­—æ®µï¼š`user_num` (ä¹°æ‰‹æ³¨å†Œèµ é€é“¶é”­æ•°é‡)
- é…ç½®å­—æ®µï¼š`seller_num` (å•†å®¶æ³¨å†Œèµ é€é“¶é”­æ•°é‡)

**æµç¨‹**:
1. ç”¨æˆ·æ³¨å†Œæ—¶ä» `system` è¡¨è¯»å– `user_num` é…ç½®
2. å°†è¯¥å€¼å†™å…¥ç”¨æˆ·è¡¨çš„ `reward` å­—æ®µ
3. è°ƒç”¨ `finance()` å‡½æ•°è®°å½•è´¢åŠ¡æµæ°´

---

### 1.2 æ¥å•æ‰£é™¤æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/controller/Task.php:219-407`

```php
// ç¬¬219è¡Œï¼šæ£€æŸ¥é“¶é”­ä½™é¢
if ($user['reward'] < 1) return $this->error('é“¶é”­ä¸è¶³,è¯·å……å€¼!');

// ç¬¬405-407è¡Œï¼šæ‰£é™¤1é“¶é”­å¹¶è®°å½•æµæ°´
$res = Db::name('users')->where('id', $this->id)->update($reward_change);
if ($res) {
    finance($this->id, 2, -1, 2, 4, "ä¹°æ‰‹æ¥ä»»åŠ¡{$task['task_number']},å†»ç»“1é“¶é”­");
}
```

**å…³é”®ç‚¹**:
- æ¥å•å‰å¿…é¡»æœ‰è‡³å°‘ **1ä¸ªé“¶é”­**
- æ¥å•æ—¶ç«‹å³æ‰£é™¤ï¼ˆå†»ç»“ï¼‰1é“¶é”­
- è®°å½•è´¢åŠ¡æµæ°´ç±»å‹ä¸º `4`ï¼ˆå†»ç»“ï¼‰

---

### 1.3 å–æ¶ˆè®¢å•æƒ©ç½šæœºåˆ¶ï¼ˆé˜²èµ„æŸæ ¸å¿ƒï¼‰

**æ–‡ä»¶ä½ç½®**: `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/controller/Task.php:710-766`

#### å…ç½šè§„åˆ™

**è§„åˆ™1ï¼šå¤œé—´å…ç½š**
```php
// ç¬¬711-715è¡Œï¼šæ™šä¸Š23:00åˆ°æ¬¡æ—¥9:00å–æ¶ˆä»»åŠ¡è¿”è¿˜1é“¶é”­
if($now<$begin_day_nine || $now>$begin_day_elevn){
    $return=[
        'reward'=>$return_reward,
    ];
}
```

**è§„åˆ™2ï¼šæ¯æ—¥å‰2å•å…ç½š**
```php
// ç¬¬722-726è¡Œï¼šç™½å¤©9:00-23:00ï¼Œæ¯å¤©å‰2å•å–æ¶ˆå…ç½š
if ($return_task_count <=2) {
    $return = [
        'reward' => $return_reward,
    ];
}
```

#### æƒ©ç½šé€»è¾‘

```php
// ç¬¬754-765è¡Œï¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦è¿”è¿˜é“¶é”­
if($now<$begin_day_nine || $now>$begin_day_elevn){
    // å¤œé—´å–æ¶ˆï¼šè¿”è¿˜é“¶é”­
    $nine_return=Db::name('users')->where('id',$this->id)->update($return);
    finance($this->id, 2, +1, 2, 13, "å®¢æœä¸ä¸Šç­æœŸé—´ï¼ˆ23ç‚¹-9ç‚¹ï¼‰è‡ªå·±æ”¾å¼ƒä»»åŠ¡{$user_task['task_number']},è§£é™¤å†»ç»“1é“¶é”­");
}else{
    if ($return_task_count <2) {
        // å‰2å•ï¼šè¿”è¿˜é“¶é”­
        $return_task_count_jia=$return_task_count+1;
        $nine_return = Db::name('users')->where('id', $this->id)->update($return);
        finance($this->id, 2, +1, 2, 13, "æ¯å¤©å‰2å•ä»»åŠ¡è‡ªè¡Œæ”¾å¼ƒä¸æ‰£é“¶é”­ï¼Œç¬¬{$return_task_count_jia}å•ï¼š{$user_task['task_number']}, æ”¾å¼ƒåè§£é™¤å†»ç»“1é“¶é”­ ç³»ç»Ÿä¼šè‡ªåŠ¨è¿”è¿˜");
    }else{
        // è¶…è¿‡2å•ï¼šæ‰£é™¤é“¶é”­ï¼ˆä¸è¿”è¿˜ï¼‰
        finance($this->id, 2, -1, 2, 13, "ç”¨æˆ·è‡ªè¡Œæ”¾å¼ƒä»»åŠ¡{$user_task['task_number']},æ‰£é™¤å†»ç»“çš„1é“¶é”­");
    }
}
```

**é˜²èµ„æŸæœºåˆ¶æ€»ç»“**:
- âœ… ç”¨æˆ·æ¶æ„å–æ¶ˆä¼šè¢«æ‰£é™¤é“¶é”­
- âœ… æ¯å¤©åªæœ‰å‰2å•å…ç½šï¼Œç¬¬3å•å¼€å§‹æ‰£é™¤
- âœ… å¤œé—´å®¢æœä¸åœ¨çº¿æ—¶å…ç½šï¼ˆäººæ€§åŒ–ï¼‰
- âœ… æ‰£é™¤çš„é“¶é”­å½’å¹³å°æ‰€æœ‰ï¼Œä¸è¿”è¿˜

---

### 1.4 æç°æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/admin/controller/Finance.php:182-195`

```php
// ç¬¬186è¡Œï¼šæ‹’ç»æç°æ—¶è¿”è¿˜é“¶é”­
$incuser = db('users')->where('id', $data_info['uid'])->setInc('reward', $data_info['price']);
```

**é…ç½®é¡¹**:
- `user_min_reward`: æœ€ä½æç°é“¶é”­æ•°
- `reward_price`: é“¶é”­å…‘æ¢äººæ°‘å¸å•ä»·

**æµç¨‹**:
1. ç”¨æˆ·ç”³è¯·æç°é“¶é”­
2. ç®¡ç†å‘˜å®¡æ ¸
3. å®¡æ ¸é€šè¿‡ï¼šé“¶é”­è½¬ä¸ºç°é‡‘
4. å®¡æ ¸æ‹’ç»ï¼šé“¶é”­è¿”è¿˜ç”¨æˆ·è´¦æˆ·

---

## 2. é‡æ„ç‰ˆç³»ç»Ÿé“¶é”­æœºåˆ¶è¯¦è§£

### 2.1 æ³¨å†Œèµ é€æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: [backend/src/users/users.service.ts:152-188](backend/src/users/users.service.ts#L152-L188)

```typescript
// ç¬¬152è¡Œï¼šä»é…ç½®ä¸­å¿ƒè¯»å–èµ é€æ•°é‡
const registerSilver = this.configService.getNumberValue('user_register_reward', 0);
const initialSilver = createUserDto.silver ?? registerSilver;

// ç¬¬159-174è¡Œï¼šåˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®åˆå§‹é“¶é”­
const newUser = this.usersRepository.create({
  username: createUserDto.username,
  password: hashedPassword,
  phone: createUserDto.phone,
  silver: initialSilver, // æ³¨å†Œèµ é€é“¶é”­
  frozenSilver: 0,
  reward: initialSilver, // ç´¯è®¡èµšå–é“¶é”­
  // ...
});

// ç¬¬179-188è¡Œï¼šè®°å½•è´¢åŠ¡æµæ°´
if (registerSilver > 0) {
  await this.fundRecordRepository.save({
    userId: savedUser.id,
    type: FundType.SILVER,
    action: FundAction.IN,
    amount: registerSilver,
    balance: registerSilver,
    description: 'é¦–æ¬¡æ³¨å†Œèµ é€é“¶é”­',
  });
}
```

**é…ç½®æ¥æº**:
- é…ç½®è¡¨ï¼š`system_configs`
- é…ç½®é”®ï¼š`user_register_reward` (ä¹°æ‰‹æ³¨å†Œèµ é€é“¶é”­)
- é…ç½®é”®ï¼š`seller_register_reward` (å•†å®¶æ³¨å†Œèµ é€é“¶é”­)
- é»˜è®¤å€¼ï¼š`0`

**é…ç½®å®šä¹‰**: [backend/src/admin-config/config.entity.ts:79-91](backend/src/admin-config/config.entity.ts#L79-L91)

```typescript
{
  key: 'user_register_reward',
  value: '0',
  group: 'register',
  label: 'ä¹°æ‰‹æ³¨å†Œèµ é€é“¶é”­',
  valueType: 'number',
},
{
  key: 'seller_register_reward',
  value: '0',
  group: 'register',
  label: 'å•†å®¶æ³¨å†Œèµ é€é“¶é”­',
  valueType: 'number',
},
```

---

### 2.2 æ¥å•æ‰£é™¤æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: [backend/src/orders/orders.service.ts:218-222](backend/src/orders/orders.service.ts#L218-L222)

```typescript
// ç¬¬218-222è¡Œï¼šæ£€æŸ¥é“¶é”­ä½™é¢
const SILVER_PREPAY = 1; // æ¥å•æŠ¼é‡‘1é“¶é”­
if (Number(user.silver) < SILVER_PREPAY) {
  throw new BadRequestException('é“¶é”­ä¸è¶³ï¼Œæ¥å•éœ€è¦1é“¶é”­ä½œä¸ºæŠ¼é‡‘');
}

// ç¬¬361-363è¡Œï¼šæ‰£é™¤é“¶é”­æŠ¼é‡‘
user.silver = Number(user.silver) - SILVER_PREPAY;
await this.usersRepository.save(user);
```

**å…³é”®ç‚¹**:
- æ¥å•å‰å¿…é¡»æœ‰è‡³å°‘ **1ä¸ªé“¶é”­**
- æ¥å•æ—¶ç«‹å³æ‰£é™¤1é“¶é”­
- è®°å½•è´¢åŠ¡æµæ°´

---

### 2.3 å–æ¶ˆè®¢å•æƒ©ç½šæœºåˆ¶

**æ–‡ä»¶ä½ç½®**: [backend/src/orders/orders.service.ts:1338-1368](backend/src/orders/orders.service.ts#L1338-L1368)

#### å…ç½šè§„åˆ™åˆ¤æ–­

**æ–‡ä»¶ä½ç½®**: [backend/src/orders/orders.service.ts:1709-1748](backend/src/orders/orders.service.ts#L1709-L1748)

```typescript
/**
 * åˆ¤æ–­å–æ¶ˆè®¢å•æ˜¯å¦åº”è¯¥æ‰£ç½š
 *
 * 1. æ¯å¤©å‰2å•å–æ¶ˆä¸æ‰£é“¶é”­
 * 2. æ™šä¸Š11ç‚¹åˆ°ç¬¬äºŒå¤©9ç‚¹å–æ¶ˆå…ç½š
 */
private async shouldPunishForCancel(
  userId: string,
  currentOrderId: string,
): Promise<boolean> {
  const now = new Date();
  const hour = now.getHours();

  // å¤œé—´å…ç½š: æ™šä¸Š11ç‚¹åˆ°ç¬¬äºŒå¤©9ç‚¹
  if (hour >= 23 || hour < 9) {
    return false;
  }

  // ä»Šæ—¥å–æ¶ˆæ¬¡æ•°æ£€æŸ¥: æ¯å¤©å‰2å•å–æ¶ˆå…ç½š
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  const todayCancelCount = await this.ordersRepository
    .createQueryBuilder('order')
    .where('order.userId = :userId', { userId })
    .andWhere('order.status = :status', { status: OrderStatus.CANCELLED })
    .andWhere('order.completedAt >= :today', { today })
    .andWhere('order.completedAt < :tomorrow', { tomorrow })
    .andWhere('order.id != :currentOrderId', { currentOrderId })
    .getCount();

  if (todayCancelCount < 2) {
    return false;
  }

  // è¶…è¿‡å…ç½šé™é¢ï¼Œéœ€è¦æ‰£ç½š
  return true;
}
```

#### æƒ©ç½šæ‰§è¡Œé€»è¾‘

```typescript
// æ£€æŸ¥æ˜¯å¦ç¬¦åˆå…ç½šæ¡ä»¶
const shouldPunish = await this.shouldPunishForCancel(userId, order.id);

// ç”¨æˆ·å–æ¶ˆè®¢å•ï¼Œæ ¹æ®è§„åˆ™å†³å®šæ˜¯å¦æ‰£é™¤é“¶é”­æŠ¼é‡‘
const silverPrepayAmount = Number(order.silverPrepay) || 0;
if (silverPrepayAmount > 0) {
  const user = await queryRunner.manager.findOne(User, {
    where: { id: userId },
  });
  if (user) {
    if (shouldPunish) {
      // é“¶é”­å·²ç»åœ¨æ¥å•æ—¶æ‰£é™¤ï¼Œå–æ¶ˆæ—¶ä¸è¿”è¿˜ï¼ˆä½œä¸ºæƒ©ç½šï¼‰
      await this.financeRecordsService.recordBuyerTaskCancelSilver(
        userId,
        silverPrepayAmount,
        Number(user.silver),
        order.id,
        'ç”¨æˆ·å–æ¶ˆè®¢å•æ‰£é™¤é“¶é”­æŠ¼é‡‘',
      );
    } else {
      // å…ç½šï¼šè¿”è¿˜é“¶é”­æŠ¼é‡‘
      user.silver = Number(user.silver) + silverPrepayAmount;
      await queryRunner.manager.save(user);
      await this.financeRecordsService.recordBuyerTaskSilverRefund(
        userId,
        silverPrepayAmount,
        Number(user.silver),
        order.id,
        'å–æ¶ˆè®¢å•å…ç½šè¿”è¿˜é“¶é”­æŠ¼é‡‘',
      );
    }
  }
}
```

---

### 2.4 æç°æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: [backend/src/withdrawals/withdrawals.service.ts](backend/src/withdrawals/withdrawals.service.ts)

**é…ç½®é¡¹**:
- `user_min_silver_withdraw`: ä¹°æ‰‹æœ€ä½æç°é“¶é”­æ•°ï¼ˆé»˜è®¤100ï¼‰
- `silver_to_rmb_rate`: é“¶é”­å…‘æ¢äººæ°‘å¸æ¯”ä¾‹ï¼ˆé»˜è®¤1:1ï¼‰

**æµç¨‹**:
1. ç”¨æˆ·ç”³è¯·æç°ï¼Œé“¶é”­ä» `silver` è½¬å…¥ `frozenSilver`
2. ç®¡ç†å‘˜å®¡æ ¸
3. å®¡æ ¸é€šè¿‡ï¼šä» `frozenSilver` æ‰£é™¤ï¼Œå‘æ”¾ç°é‡‘
4. å®¡æ ¸æ‹’ç»ï¼šä» `frozenSilver` è¿”è¿˜åˆ° `silver`

---

## 3. ä¸¤ç‰ˆæœ¬å¯¹æ¯”åˆ†æ

### 3.1 åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½æ¨¡å— | åŸç‰ˆç³»ç»Ÿ | é‡æ„ç‰ˆç³»ç»Ÿ | ä¸€è‡´æ€§ |
|---------|---------|-----------|--------|
| æ³¨å†Œèµ é€é“¶é”­ | âœ… æ”¯æŒï¼Œé…ç½®å­—æ®µ `user_num` | âœ… æ”¯æŒï¼Œé…ç½®å­—æ®µ `user_register_reward` | âœ… ä¸€è‡´ |
| æ¥å•æ‰£é™¤1é“¶é”­ | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä¸€è‡´ |
| é“¶é”­ä¸è¶³é™åˆ¶æ¥å• | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä¸€è‡´ |
| å¤œé—´å–æ¶ˆå…ç½š | âœ… 23:00-09:00 | âœ… 23:00-09:00 | âœ… ä¸€è‡´ |
| æ¯æ—¥å‰2å•å…ç½š | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä¸€è‡´ |
| è¶…é¢å–æ¶ˆæ‰£ç½š | âœ… ç¬¬3å•èµ·æ‰£é™¤ | âœ… ç¬¬3å•èµ·æ‰£é™¤ | âœ… ä¸€è‡´ |
| é“¶é”­æç° | âœ… æ”¯æŒ | âœ… æ”¯æŒï¼Œå¢åŠ å†»ç»“æœºåˆ¶ | âœ… ä¸€è‡´ï¼ˆä¼˜åŒ–ï¼‰ |
| è´¢åŠ¡æµæ°´è®°å½• | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä¸€è‡´ |

---

### 3.2 å…³é”®å·®å¼‚

#### å·®å¼‚1ï¼šé…ç½®å­—æ®µåç§°

| é¡¹ç›® | åŸç‰ˆç³»ç»Ÿ | é‡æ„ç‰ˆç³»ç»Ÿ |
|-----|---------|-----------|
| ä¹°æ‰‹æ³¨å†Œèµ é€ | `user_num` | `user_register_reward` |
| å•†å®¶æ³¨å†Œèµ é€ | `seller_num` | `seller_register_reward` |
| é…ç½®è¡¨å | `tfkz_system` | `system_configs` |

#### å·®å¼‚2ï¼šæç°æµç¨‹ä¼˜åŒ–

**åŸç‰ˆç³»ç»Ÿ**:
- æç°ç”³è¯·åç›´æ¥æ‰£é™¤ `reward`
- æ‹’ç»æ—¶è¿”è¿˜ `reward`

**é‡æ„ç‰ˆç³»ç»Ÿ**:
- æç°ç”³è¯·åä» `silver` è½¬å…¥ `frozenSilver`ï¼ˆå†»ç»“ï¼‰
- å®¡æ ¸é€šè¿‡åä» `frozenSilver` æ‰£é™¤
- å®¡æ ¸æ‹’ç»åä» `frozenSilver` è¿”è¿˜åˆ° `silver`
- **ä¼˜åŠ¿**: æ›´æ¸…æ™°çš„èµ„é‡‘çŠ¶æ€ç®¡ç†

#### å·®å¼‚3ï¼šé»˜è®¤é…ç½®å€¼

**åŸç‰ˆç³»ç»Ÿ**:
- é»˜è®¤èµ é€1é“¶é”­ï¼ˆæ ¹æ®ä½ çš„æè¿°ï¼‰

**é‡æ„ç‰ˆç³»ç»Ÿ**:
- é»˜è®¤èµ é€0é“¶é”­ï¼ˆéœ€è¦åœ¨åå°é…ç½®ï¼‰

---

## 4. èµ„æŸé£é™©åˆ†æ

### 4.1 ä½ æå‡ºçš„èµ„æŸåœºæ™¯

**åœºæ™¯æè¿°**:
> æ³¨å†Œèµ é€1é“¶é”­ â†’ æ¥å•æ‰£é™¤1é“¶é”­ â†’ å®Œæˆä»»åŠ¡èµšå–ä½£é‡‘ â†’ å…¨éƒ¨æç° â†’ ç”¨æˆ·ä½™é¢ä¸º0 â†’ æ— æ³•å†æ¬¡æ¥å•

### 4.2 é£é™©è¯„ä¼°

#### âŒ è¿™ä¸æ˜¯èµ„æŸé—®é¢˜

**åŸå› åˆ†æ**:

1. **é“¶é”­æ˜¯æŠ¼é‡‘ï¼Œä¸æ˜¯æˆæœ¬**
   - æ¥å•æ‰£é™¤çš„1é“¶é”­æ˜¯"å†»ç»“"ï¼Œä¸æ˜¯æ¶ˆè€—
   - å®Œæˆä»»åŠ¡åï¼Œè¿™1é“¶é”­ä¼šè¿”è¿˜ç»™ç”¨æˆ·
   - ç”¨æˆ·å®é™…å¯æç°çš„æ˜¯ï¼šä½£é‡‘ + è¿”è¿˜çš„æŠ¼é‡‘

2. **åŸç‰ˆç³»ç»Ÿçš„å®é™…æµç¨‹**:
   ```
   æ³¨å†Œ: reward = 1
   æ¥å•: reward = 0 (å†»ç»“1é“¶é”­)
   å®Œæˆ: reward = 1 + ä½£é‡‘ (è¿”è¿˜æŠ¼é‡‘ + è·å¾—ä½£é‡‘)
   æç°: reward = 0 (æç°æ‰€æœ‰)
   å†æ¥å•: rewardä¸è¶³ï¼Œæ— æ³•æ¥å• âŒ
   ```

3. **è¿™æ˜¯è®¾è®¡ç¼ºé™·ï¼Œä¸æ˜¯èµ„æŸ**
   - å¹³å°æ²¡æœ‰æŸå¤±ï¼ˆæŠ¼é‡‘å·²æ‰£é™¤ï¼‰
   - ç”¨æˆ·æ— æ³•ç»§ç»­æ¥å•ï¼ˆä½“éªŒå·®ï¼‰
   - **è§£å†³æ–¹æ¡ˆ**: å®Œæˆä»»åŠ¡åè¿”è¿˜æŠ¼é‡‘

### 4.3 çœŸæ­£çš„èµ„æŸé£é™©ç‚¹

#### é£é™©ç‚¹1ï¼šæ¶æ„å–æ¶ˆè®¢å•

**åœºæ™¯**:
- ç”¨æˆ·æ³¨å†Œè·å¾—1é“¶é”­
- æ¥å•æ‰£é™¤1é“¶é”­
- åœ¨å…ç½šæ—¶æ®µï¼ˆå¤œé—´æˆ–å‰2å•ï¼‰å–æ¶ˆ
- é“¶é”­è¿”è¿˜ï¼Œç”¨æˆ·å¯ä»¥æ— é™é‡å¤

**é˜²æŠ¤æªæ–½**:
- âœ… æ¯å¤©åªæœ‰å‰2å•å…ç½š
- âœ… ç¬¬3å•èµ·å¿…é¡»æ‰£é™¤
- âœ… å¤œé—´å…ç½šæ˜¯äººæ€§åŒ–è®¾è®¡ï¼Œé£é™©å¯æ§

#### é£é™©ç‚¹2ï¼šæç°åæ— æ³•æ¥å•

**åœºæ™¯**:
- ç”¨æˆ·å®Œæˆä»»åŠ¡åå…¨éƒ¨æç°
- è´¦æˆ·ä½™é¢ä¸º0
- æ— æ³•æ¥ä¸‹ä¸€å•

**å½±å“**:
- âŒ ä¸æ˜¯å¹³å°èµ„æŸ
- âœ… æ˜¯ç”¨æˆ·ä½“éªŒé—®é¢˜
- ğŸ’¡ å»ºè®®ï¼šå®Œæˆä»»åŠ¡åè‡ªåŠ¨è¿”è¿˜æŠ¼é‡‘

---

## 5. é‡æ„ç‰ˆé…ç½®é—®é¢˜è¯Šæ–­

### 5.1 é—®é¢˜æè¿°

> æˆ‘åœ¨åå°è®¾ç½®äº†æ³¨å†Œèµ é€1é“¶é”­å¥½åƒæ²¡æœ‰ç”Ÿæ•ˆ

### 5.2 å¯èƒ½åŸå› 

#### åŸå› 1ï¼šé…ç½®æœªä¿å­˜åˆ°æ•°æ®åº“

**æ£€æŸ¥æ–¹æ³•**:
```sql
SELECT * FROM system_configs WHERE `key` = 'user_register_reward';
```

**é¢„æœŸç»“æœ**:
```
key: user_register_reward
value: 1
```

#### åŸå› 2ï¼šé…ç½®ç¼“å­˜æœªåˆ·æ–°

**æ£€æŸ¥ä»£ç **: [backend/src/admin-config/admin-config.service.ts](backend/src/admin-config/admin-config.service.ts)

**å¯èƒ½éœ€è¦**:
- é‡å¯åç«¯æœåŠ¡
- æ¸…é™¤é…ç½®ç¼“å­˜

#### åŸå› 3ï¼šå‰ç«¯æ³¨å†Œæ—¶ä¼ å…¥äº† `silver` å‚æ•°

**ä»£ç é€»è¾‘**:
```typescript
const initialSilver = createUserDto.silver ?? registerSilver;
```

**è¯´æ˜**:
- å¦‚æœå‰ç«¯ä¼ å…¥äº† `silver` å‚æ•°ï¼Œä¼šä¼˜å…ˆä½¿ç”¨å‰ç«¯å€¼
- åªæœ‰å‰ç«¯æœªä¼ å…¥æ—¶ï¼Œæ‰ä½¿ç”¨é…ç½®å€¼

#### åŸå› 4ï¼šé…ç½®å€¼ä¸ºå­—ç¬¦ä¸²ç±»å‹

**æ£€æŸ¥ä»£ç **:
```typescript
const registerSilver = this.configService.getNumberValue('user_register_reward', 0);
```

**è¯´æ˜**:
- `getNumberValue` ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæ•°å­—
- å¦‚æœé…ç½®å€¼æ˜¯ `"1"` å­—ç¬¦ä¸²ï¼Œåº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ

---

### 5.3 è¯Šæ–­æ­¥éª¤

#### æ­¥éª¤1ï¼šæ£€æŸ¥æ•°æ®åº“é…ç½®

```sql
-- æŸ¥çœ‹é…ç½®å€¼
SELECT * FROM system_configs WHERE `key` = 'user_register_reward';

-- å¦‚æœä¸å­˜åœ¨ï¼Œæ’å…¥é…ç½®
INSERT INTO system_configs (`key`, `value`, `group`, `label`, `valueType`)
VALUES ('user_register_reward', '1', 'register', 'ä¹°æ‰‹æ³¨å†Œèµ é€é“¶é”­', 'number');
```

#### æ­¥éª¤2ï¼šæ£€æŸ¥æ–°æ³¨å†Œç”¨æˆ·

```sql
-- æŸ¥çœ‹æœ€è¿‘æ³¨å†Œçš„ç”¨æˆ·
SELECT id, username, phone, silver, reward, createdAt
FROM users
ORDER BY createdAt DESC
LIMIT 10;
```

#### æ­¥éª¤3ï¼šæ£€æŸ¥è´¢åŠ¡æµæ°´

```sql
-- æŸ¥çœ‹æ³¨å†Œèµ é€æµæ°´
SELECT * FROM fund_records
WHERE description LIKE '%æ³¨å†Œèµ é€%'
ORDER BY createdAt DESC
LIMIT 10;
```

#### æ­¥éª¤4ï¼šæµ‹è¯•æ³¨å†Œæµç¨‹

1. ç¡®è®¤é…ç½®å€¼ä¸º `1`
2. é‡å¯åç«¯æœåŠ¡
3. æ³¨å†Œæ–°ç”¨æˆ·
4. æ£€æŸ¥ç”¨æˆ·çš„ `silver` å’Œ `reward` å­—æ®µ
5. æ£€æŸ¥ `fund_records` è¡¨æ˜¯å¦æœ‰æµæ°´è®°å½•

---

## 6. å»ºè®®ä¸æ”¹è¿›

### 6.1 çŸ­æœŸä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰

#### ä¿®å¤1ï¼šç¡®è®¤é…ç½®ç”Ÿæ•ˆ

**æ“ä½œ**:
1. ç™»å½•æ•°æ®åº“
2. æ‰§è¡ŒSQLç¡®è®¤é…ç½®å­˜åœ¨ä¸”å€¼æ­£ç¡®
3. é‡å¯åç«¯æœåŠ¡
4. æµ‹è¯•æ³¨å†Œæµç¨‹

#### ä¿®å¤2ï¼šæ·»åŠ æ—¥å¿—

**å»ºè®®åœ¨æ³¨å†Œä»£ç ä¸­æ·»åŠ æ—¥å¿—**:
```typescript
const registerSilver = this.configService.getNumberValue('user_register_reward', 0);
console.log('[æ³¨å†Œ] é…ç½®çš„èµ é€é“¶é”­æ•°:', registerSilver);
console.log('[æ³¨å†Œ] å®é™…èµ é€é“¶é”­æ•°:', initialSilver);
```

---

### 6.2 ä¸­æœŸä¼˜åŒ–ï¼ˆå»ºè®®å®æ–½ï¼‰

#### ä¼˜åŒ–1ï¼šå®Œæˆä»»åŠ¡åè¿”è¿˜æŠ¼é‡‘

**é—®é¢˜**: ç”¨æˆ·æç°åæ— æ³•æ¥å•

**å»ºè®®**:
- å®Œæˆä»»åŠ¡æ—¶è‡ªåŠ¨è¿”è¿˜1é“¶é”­æŠ¼é‡‘
- æˆ–è€…ï¼šæç°æ—¶ä¿ç•™1é“¶é”­ä½œä¸ºæŠ¼é‡‘

**å®ç°æ–¹æ¡ˆ**:
```typescript
// è®¢å•å®Œæˆæ—¶
user.silver = Number(user.silver) + 1; // è¿”è¿˜æŠ¼é‡‘
user.silver = Number(user.silver) + commission; // å¢åŠ ä½£é‡‘
```

#### ä¼˜åŒ–2ï¼šæœ€ä½ä½™é¢é™åˆ¶

**å»ºè®®**:
- æç°æ—¶è¦æ±‚ä¿ç•™è‡³å°‘1é“¶é”­
- æˆ–è€…ï¼šæç¤ºç”¨æˆ·ä¿ç•™æŠ¼é‡‘ä»¥ä¾¿ç»§ç»­æ¥å•

**å®ç°æ–¹æ¡ˆ**:
```typescript
// æç°éªŒè¯
if (user.silver - amount < 1) {
  throw new BadRequestException('æç°åä½™é¢ä¸è¶³1é“¶é”­ï¼Œå°†æ— æ³•æ¥å•ï¼Œå»ºè®®ä¿ç•™1é“¶é”­');
}
```

#### ä¼˜åŒ–3ï¼šæŠ¼é‡‘è‡ªåŠ¨å……å€¼

**å»ºè®®**:
- ç”¨æˆ·å®Œæˆä¸€å®šæ•°é‡ä»»åŠ¡åï¼Œè‡ªåŠ¨èµ é€æŠ¼é‡‘
- ä¾‹å¦‚ï¼šå®Œæˆ10å•åèµ é€1é“¶é”­

---

### 6.3 é•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

#### ä¼˜åŒ–1ï¼šåŠ¨æ€æŠ¼é‡‘åˆ¶åº¦

**å»ºè®®**:
- æ ¹æ®ç”¨æˆ·ä¿¡ç”¨ç­‰çº§è°ƒæ•´æŠ¼é‡‘
- é«˜ä¿¡ç”¨ç”¨æˆ·å¯ä»¥å…æŠ¼é‡‘æ¥å•

#### ä¼˜åŒ–2ï¼šæŠ¼é‡‘æ± æœºåˆ¶

**å»ºè®®**:
- ç”¨æˆ·å¯ä»¥å……å€¼æŠ¼é‡‘æ± 
- æŠ¼é‡‘æ± ä½™é¢ä¸å¯æç°ï¼Œåªç”¨äºæ¥å•

#### ä¼˜åŒ–3ï¼šä¼šå‘˜å…æŠ¼é‡‘

**å»ºè®®**:
- VIPä¼šå‘˜å…æŠ¼é‡‘æ¥å•
- å¢åŠ VIPå¸å¼•åŠ›

---

## 7. æ€»ç»“

### 7.1 æ ¸å¿ƒç»“è®º

1. âœ… **åŸç‰ˆç³»ç»Ÿè®¾è®¡åˆç†**
   - æœ‰å®Œå–„çš„é˜²èµ„æŸæœºåˆ¶
   - é€šè¿‡å–æ¶ˆæƒ©ç½šæ§åˆ¶æ¶æ„è¡Œä¸º
   - æŠ¼é‡‘åˆ¶åº¦æœ‰æ•ˆé˜²æ­¢åˆ·å•

2. âœ… **é‡æ„ç‰ˆé€»è¾‘æ­£ç¡®**
   - æ ¸å¿ƒæœºåˆ¶å·²æ­£ç¡®è¿ç§»
   - ä»£ç è´¨é‡æ›´é«˜
   - å¢åŠ äº†å†»ç»“æœºåˆ¶ï¼ˆä¼˜åŒ–ï¼‰

3. âš ï¸ **é…ç½®é—®é¢˜éœ€è¦æ’æŸ¥**
   - æ³¨å†Œèµ é€åŠŸèƒ½ä»£ç æ­£ç¡®
   - å¯èƒ½æ˜¯é…ç½®æœªç”Ÿæ•ˆ
   - éœ€è¦æŒ‰ç…§è¯Šæ–­æ­¥éª¤æ’æŸ¥

4. âŒ **ä¸å­˜åœ¨èµ„æŸé£é™©**
   - æŠ¼é‡‘åˆ¶åº¦æœ‰æ•ˆé˜²æŠ¤
   - å–æ¶ˆæƒ©ç½šæœºåˆ¶å®Œå–„
   - æç°åæ— æ³•æ¥å•æ˜¯ä½“éªŒé—®é¢˜ï¼Œä¸æ˜¯èµ„æŸ

### 7.2 ç«‹å³è¡ŒåŠ¨é¡¹

1. **æ£€æŸ¥æ•°æ®åº“é…ç½®**
   ```sql
   SELECT * FROM system_configs WHERE `key` = 'user_register_reward';
   ```

2. **ç¡®è®¤é…ç½®å€¼**
   - åº”è¯¥æ˜¯ `'1'` æˆ– `1`
   - ç±»å‹åº”è¯¥æ˜¯ `number`

3. **é‡å¯åç«¯æœåŠ¡**
   - æ¸…é™¤é…ç½®ç¼“å­˜
   - é‡æ–°åŠ è½½é…ç½®

4. **æµ‹è¯•æ³¨å†Œæµç¨‹**
   - æ³¨å†Œæ–°ç”¨æˆ·
   - æ£€æŸ¥ `silver` å’Œ `reward` å­—æ®µ
   - æ£€æŸ¥è´¢åŠ¡æµæ°´è®°å½•

### 7.3 ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | å»ºè®® | å½±å“ |
|-------|-----|------|
| ğŸ”´ P0 | ä¿®å¤é…ç½®ä¸ç”Ÿæ•ˆé—®é¢˜ | å½±å“æ–°ç”¨æˆ·æ³¨å†Œä½“éªŒ |
| ğŸŸ¡ P1 | å®Œæˆä»»åŠ¡åè¿”è¿˜æŠ¼é‡‘ | å½±å“ç”¨æˆ·æŒç»­æ¥å• |
| ğŸŸ¡ P1 | æç°æ—¶ä¿ç•™æŠ¼é‡‘æç¤º | æ”¹å–„ç”¨æˆ·ä½“éªŒ |
| ğŸŸ¢ P2 | åŠ¨æ€æŠ¼é‡‘åˆ¶åº¦ | é•¿æœŸä¼˜åŒ– |
| ğŸŸ¢ P2 | VIPå…æŠ¼é‡‘ | å¢åŠ VIPä»·å€¼ |

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

#### åŸç‰ˆç³»ç»Ÿ
- `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/controller/Login.php` - æ³¨å†Œé€»è¾‘
- `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/controller/Task.php` - æ¥å•/å–æ¶ˆé€»è¾‘
- `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/admin/controller/Finance.php` - æç°å®¡æ ¸
- `/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/common.php` - è´¢åŠ¡å‡½æ•°

#### é‡æ„ç‰ˆç³»ç»Ÿ
- [backend/src/users/users.service.ts](backend/src/users/users.service.ts) - ç”¨æˆ·æœåŠ¡ï¼ˆæ³¨å†Œï¼‰
- [backend/src/orders/orders.service.ts](backend/src/orders/orders.service.ts) - è®¢å•æœåŠ¡ï¼ˆæ¥å•/å–æ¶ˆï¼‰
- [backend/src/withdrawals/withdrawals.service.ts](backend/src/withdrawals/withdrawals.service.ts) - æç°æœåŠ¡
- [backend/src/admin-config/config.entity.ts](backend/src/admin-config/config.entity.ts) - é…ç½®å®šä¹‰
- [backend/src/finance-records/finance-records.service.ts](backend/src/finance-records/finance-records.service.ts) - è´¢åŠ¡æµæ°´

### B. é…ç½®é¡¹å¯¹ç…§è¡¨

| åŠŸèƒ½ | åŸç‰ˆé…ç½®å­—æ®µ | é‡æ„ç‰ˆé…ç½®å­—æ®µ | é»˜è®¤å€¼ |
|-----|------------|--------------|--------|
| ä¹°æ‰‹æ³¨å†Œèµ é€ | `user_num` | `user_register_reward` | 0 |
| å•†å®¶æ³¨å†Œèµ é€ | `seller_num` | `seller_register_reward` | 0 |
| æœ€ä½æç°é“¶é”­ | `user_min_reward` | `user_min_silver_withdraw` | 100 |
| é“¶é”­å…‘æ¢æ¯”ä¾‹ | `reward_price` | `silver_to_rmb_rate` | 1 |

---

**æŠ¥å‘Šç»“æŸ**
