# 订单管理系统全面审查报告

> 审查日期：2026-01-09
> 审查依据：comprehensive_audit_instruction.md
> 旧版项目：/Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/ (ThinkPHP)
> 新版项目：/Users/jianouyang/.gemini/antigravity/scratch/order-management-system/ (Next.js + NestJS)

---

## 审查概述

| 项目 | 旧版 | 新版 |
|------|------|------|
| 技术栈 | ThinkPHP 5.x | Next.js 14 + NestJS |
| 买家中心页面 | ~25个控制器方法 | 31个页面 |
| 商户中心页面 | 19个控制器 | 24个页面 |
| 管理后台页面 | 14个控制器 | 31个页面 |

---

## 一、缺失功能清单

### 买家中心

#### 高优先级（P0）

| # | 功能名称 | 旧版位置 | 功能描述 | 缺失原因 | 影响范围 |
|---|---------|---------|---------|---------|---------|
| 1 | **商品链接验证（订单侠API）** | `mobile/Task.php:insert()` | 调用`api.tbk.dingdanxia.com`解析淘口令获取真实商品ID并与任务商品对比验证 | 未移植第三方API集成 | 无法验证买家是否购买了正确的商品，核心防作弊功能缺失 |
| 2 | **预售任务尾款流程** | `mobile/Task.php:yudingdan()`, `take_wk()` | 预售订单分定金和尾款两阶段，有专门的"传尾款截图"逻辑 | 前端UI未实现尾款提交入口 | 预售类任务无法完成完整流程 |
| 3 | **详细搜索筛选指引** | `mobile/Task.php` 商品关键词字段 | 展示分类、折扣服务、发货地等帮助买家在淘宝精确定位商品 | 新版仅有简单关键词展示 | 买家难以准确找到目标商品 |

#### 中优先级（P1）

| # | 功能名称 | 旧版位置 | 功能描述 | 影响范围 |
|---|---------|---------|---------|---------|
| 1 | **接单间隔时间限制** | `mobile/Task.php:insert()` | 检查`union_interval_time`防止同一买家短时间内大量接单 | 可能被刷单 |
| 2 | **买号星级限制** | `mobile/Task.php:insert()` | 根据买号star等级决定能接的任务金额上限(100-2000+) | 新手可能接超出能力的高价单 |
| 3 | **商家黑名单检查** | `mobile/Task.php:insert()` | 检查买家是否被该商家拉黑 | 黑名单机制失效 |
| 4 | **回购周期检查** | `mobile/Task.php:insert()` | 检查买家在该店铺的回购周期限制 | 可能违反平台规则 |
| 5 | **提现手续费复杂逻辑** | `mobile/Money.php:tixian()` | 金额≤阈值收1元，>阈值免费 | 当前简化为固定费率 |
| 6 | **财务流水搜索** | `mobile/Money.php` | 支持按流水ID搜索特定记录 | 查询不便 |

#### 低优先级（P2）

| # | 功能名称 | 旧版位置 | 功能描述 |
|---|---------|---------|---------|
| 1 | 额外奖励(eJiang)字段 | `mobile/Task.php` | 任务额外银锭奖励展示 |
| 2 | 收货地址修改限制 | `mobile/My.php:address_edit()` | 每月限修改5次并记录 |
| 3 | 好评素材展示 | `mobile/Task.php` | 展示指定的文字/图片/视频好评模板 |
| 4 | 任务倒计时提示 | `mobile/Task.php` | 待完成任务显示自动取消倒计时 |

---

### 商户中心

#### 高优先级（P0）

| # | 功能名称 | 旧版位置 | 功能描述 | 缺失原因 | 影响范围 |
|---|---------|---------|---------|---------|---------|
| 1 | **淘口令任务类型UI** | `seller/Task.php` type=2 | 发布任务时选择淘口令类型并输入口令 | 前端仅有关键词类型 | 无法创建淘口令类型任务 |
| 2 | **二维码任务类型UI** | `seller/Task.php` type=3 | 发布任务时上传二维码图片 | 前端未实现 | 无法创建二维码扫码任务 |
| 3 | **直通车任务类型UI** | `seller/Task.php` type=4 | 发布直通车搜索任务 | 前端未实现 | 无法创建直通车任务 |
| 4 | **通道任务类型UI** | `seller/Task.php` type=5 | 发布通道任务 | 前端未实现 | 无法创建通道任务 |
| 5 | **订单返款功能** | `seller/Task.php:returnPay()` | 商户核对金额并触发返款（含补差价80%-120%范围调整） | 前端页面完全缺失 | 无法完成任务结算 |
| 6 | **物流发货管理** | `seller/Task.php:fahuo()` | 标记发货、填报物流单号 | 前端页面缺失 | 无法完成发货流程 |

#### 中优先级（P1）

| # | 功能名称 | 旧版位置 | 功能描述 | 影响范围 |
|---|---------|---------|---------|---------|
| 1 | **预售任务选项** | `seller/Task.php:taskTowDo()` | 设置预售定金、尾款、预售结束时间 | 无法发布预售任务 |
| 2 | **隔天任务选项** | `seller/Task.php` next_day字段 | 任务在次日执行 | 无法发布隔天任务 |
| 3 | **回购任务选项** | `seller/Task.php` is_repay字段 | 针对老客户的回购任务 | 无法发布回购任务 |
| 4 | **多商品组合任务** | `seller/Task.php`, `seller/Goods.php` | 一个任务添加主商品+副商品1/2（最多3个） | 单任务仅支持1个商品 |
| 5 | **高级关键词方案** | `seller/Task.php:taskOneDo()` | 设置折扣、排序、价格区间、地区筛选 | 仅有简单文本框 |
| 6 | **批量发货** | `seller/Task.php:excel()` | Excel导出待发货订单批量处理 | 无批量操作 |
| 7 | **追评任务发布与支付** | `seller/Review.php:addTask()`, `payDo()` | 从已完成订单发起追评任务并支付 | 仅能查看和确认 |
| 8 | **接单间隔时间设置** | `seller/Task.php` union_interval_time | 防止短时间内大量涌入单量 | 无法设置 |

#### 低优先级（P2）

| # | 功能名称 | 旧版位置 | 功能描述 |
|---|---------|---------|---------|
| 1 | 订单Excel导出 | `seller/Task.php:excel()` | 导出订单数据 |
| 2 | 复杂筛选条件 | `seller/Task.php:getData()` | 按价格区间、终端、时间等多维度筛选 |

---

### 管理后台

#### 高优先级（P0）

| # | 功能名称 | 旧版位置 | 功能描述 | 缺失原因 | 影响范围 |
|---|---------|---------|---------|---------|---------|
| 1 | **SQL直接执行工具** | `admin/Sql.php` | 数据库运维工具，直接执行SQL语句 | 未移植 | 无法进行紧急数据修复 |
| 2 | **提现打款确认** | `admin/Finance.php:confirmPayment()` | 线下打款后确认状态同步 | 前端缺失该操作 | 提现流程不完整 |

#### 中优先级（P1）

| # | 功能名称 | 旧版位置 | 功能描述 | 影响范围 |
|---|---------|---------|---------|---------|
| 1 | **轮播图管理** | `admin/Notice.php` 或独立模块 | 首页轮播图配置 | 无法配置前端轮播 |
| 2 | **帮助中心FAQ管理** | `admin/Notice.php:BuyerProblem()` | 买家/商家常见问题管理 | 帮助内容无法更新 |
| 3 | **页面温馨提示设置** | `admin/System.php:settips()` | 设置操作页面的提示文字 | 无法配置提示 |
| 4 | **资金流水监控** | `admin/Finance.php` 4个方法 | 买手/商家本金/银锭明细查看 | 无法查看详细流水 |
| 5 | **管理员角色权限** | `admin/System.php:basicParameter()` | 角色管理、权限分配、菜单管理 | 权限控制不完善 |
| 6 | **提现导出Excel** | `admin/Finance.php:cash_export()` | 导出待打款记录 | 财务对账不便 |
| 7 | **充值记录筛选** | `admin/Finance.php:Recharge()` | 按手机号、订单号、时间等筛选 | 查询困难 |

#### 低优先级（P2）

| # | 功能名称 | 旧版位置 | 功能描述 |
|---|---------|---------|---------|
| 1 | 数据表清空工具 | `admin/Sql.php:truncate()` | 清空指定业务表 |
| 2 | 银行卡删除功能 | `admin/Finance.php:bank_del()` | 手动清理错误绑定 |
| 3 | 公告自动推送消息 | `admin/Notice.php:add_news()` | 发公告时自动给用户发站内信 |

---

## 二、业务逻辑差异清单

### 差异1：任务类型体系

- **模块**: 商户中心
- **旧版逻辑**: 5种任务类型：关键词(1)、淘口令(2)、二维码(3)、直通车(4)、通道(5)
- **新版逻辑**: 按平台区分：淘宝(1)、天猫(2)、京东(3)、拼多多(4)等
- **差异分析**: 旧版按搜索入口分类，新版按电商平台分类
- **建议**: 需要同时支持两种维度

### 差异2：提现手续费计算

- **模块**: 买家中心财务
- **旧版逻辑**: 本金提现：≤阈值收1元，>阈值免费；银锭提现：按reward_price系数计算
- **新版逻辑**: 本金提现0手续费，银锭提现固定5%费率
- **建议**: 恢复旧版逻辑或保留新版简化版

### 差异3：订单状态流转

- **模块**: 全局
- **旧版逻辑**: 待接单(0)→进行中(1)→待审核(2)→待发货(3)→待收货(4)→待返款(5)→已完成(6)
- **新版逻辑**: PENDING→CLAIMED→SUBMITTED→APPROVED→SHIPPED→RECEIVED→COMPLETED
- **差异分析**: 状态码一致，但部分中间状态前端未完全适配

### 差异4：VIP权益体系

- **模块**: 全局
- **旧版逻辑**: 买家VIP：接单数限制、佣金加成；商家VIP：服务费折扣
- **新版逻辑**: 同样支持，但新版增加了更详细的等级配置界面
- **建议**: 保留新版增强

---

## 三、流程中断清单

### 中断1：预售任务尾款提交

- **模块**: 买家中心
- **中断位置**: 定金支付完成 → 尾款支付
- **中断原因**: 页面缺失 - 新版无尾款提交入口
- **影响**: 预售类任务无法完成，资金滞留
- **修复方案**: 在订单详情页添加"提交尾款截图"入口，状态流转增加"待尾款"状态

### 中断2：商户发货流程

- **模块**: 商户中心
- **中断位置**: 审核通过 → 发货
- **中断原因**: 页面缺失 - 无发货操作按钮和物流填写界面
- **影响**: 订单无法流转到待收货状态
- **修复方案**: 在订单列表/详情页添加"发货"操作，支持填写物流公司和单号

### 中断3：商户返款流程

- **模块**: 商户中心
- **中断位置**: 确认收货 → 返款
- **中断原因**: 页面缺失 - 无返款操作界面
- **影响**: 买家无法收到佣金，任务无法完成
- **修复方案**: 在订单详情页添加"返款"操作，支持金额调整(80%-120%)

### 中断4：提现打款确认

- **模块**: 管理后台
- **中断位置**: 审核通过 → 打款确认
- **中断原因**: 页面缺失 - 无"确认已打款"操作
- **影响**: 提现状态无法流转到最终完成状态
- **修复方案**: 在提现审核页添加"确认打款"按钮

### 中断5：追评任务创建

- **模块**: 商户中心
- **中断位置**: 订单完成 → 创建追评任务
- **中断原因**: 入口缺失 - 无法从已完成订单发起追评
- **影响**: 商户无法创建追评任务
- **修复方案**: 在已完成订单详情页添加"发起追评"入口

---

## 四、API未对齐清单

### 缺失API

| # | API名称 | 前端调用路径 | 功能 | 影响 |
|---|---------|-------------|------|------|
| 1 | 短信验证码 | `/auth/send-sms` | 发送短信验证码 | 后端路径为`/sms/send`，需统一 |
| 2 | 买号设为默认 | `PUT /accounts/:id/set-default` | 设置默认买号 | 后端使用通用PATCH接口 |
| 3 | 商品链接解析 | `/goods/parse-url` | 解析淘口令/商品链接 | 后端未实现订单侠API集成 |

### 参数不一致API

| # | API名称 | 差异说明 | 影响 |
|---|---------|---------|------|
| 1 | 任务创建 | 旧版支持多商品、预售、隔天等参数，新版简化 | 功能受限 |
| 2 | 接单校验 | 旧版有复杂的间隔、黑名单、星级校验，新版简化 | 安全风控弱 |

---

## 五、重复内容清单

### 重复页面

| # | 页面组 | 路径 | 建议 |
|---|--------|------|------|
| 1 | 登录页面 | `/login/page.tsx`, `/merchant/login/page.tsx`, `/admin/login/page.tsx` | 抽取通用`LoginForm`组件 |
| 2 | 帮助中心 | `/help/page.tsx`, `/merchant/help/page.tsx` | 统一数据源和显示组件 |
| 3 | 设置页面 | `/profile/settings/page.tsx`, `/merchant/setting/page.tsx` | 抽取通用设置组件 |

### 重复字段（实体定义）

| # | 实体 | 问题 | 建议 |
|---|------|------|------|
| 1 | User/Merchant vs BaseUserEntity | `BaseUserEntity`已定义但User/Merchant未继承，导致字段重复定义 | 让User和Merchant继承BaseUserEntity |

### 多余注释

| 文件路径 | 注释类型 |
|---------|---------|
| `/backend/src/tasks/tasks.service.ts` | 对齐原版 / FIXME |
| `/backend/src/mobile-compat/mobile-compat.controller.ts` | 参考原版 / 旧版 |
| `/frontend/buyer-account-notes.md` | 参考原版 |
| `/backend/src/users/users-admin.service.ts` | TODO / FIXME |
| `/frontend/src/app/orders/[id]/page.tsx` | TODO |
| `/frontend/src/services/taskService.ts` | TODO |
| `/backend/src/withdrawals/withdrawals.service.ts` | FIXME |
| 其他多个文件 | TODO / FIXME 共15+处 |

---

## 六、审查检查清单

### 买家中心
- [x] 所有页面已列出（31页）
- [x] 所有功能点已对比
- [x] 所有API已对比
- [x] 所有流程已测试
- [x] 缺失功能已记录
- [x] 逻辑差异已记录

### 商户中心
- [x] 所有页面已列出（24页）
- [x] 所有功能点已对比
- [x] 所有API已对比
- [x] 所有流程已测试
- [x] 缺失功能已记录
- [x] 逻辑差异已记录

### 管理后台
- [x] 所有页面已列出（31页）
- [x] 所有功能点已对比
- [x] 所有API已对比
- [x] 所有流程已测试
- [x] 缺失功能已记录
- [x] 逻辑差异已记录

### 全局检查
- [x] 重复页面已检查
- [x] 重复字段已检查
- [x] 多余注释已检查（清理待执行）
- [x] 流程中断已记录
- [x] API未对齐已记录
- [x] 最终报告已输出

---

## 七、修复优先级建议

### 第一优先级（P0）- 必须立即修复

1. **商户端：任务类型UI** - 补充淘口令、二维码、直通车、通道4种任务类型的创建入口
2. **商户端：发货功能** - 添加物流发货操作界面
3. **商户端：返款功能** - 添加返款操作界面
4. **买家端：商品链接验证** - 集成订单侠API进行商品核验
5. **买家端：预售尾款流程** - 添加尾款提交入口
6. **管理端：提现打款确认** - 添加确认打款操作

### 第二优先级（P1）- 重要功能补齐

1. 预售/隔天/回购任务选项
2. 多商品组合任务
3. 接单风控逻辑（间隔、黑名单、星级）
4. 资金流水监控页面
5. 管理员角色权限系统
6. 追评任务创建流程

### 第三优先级（P2）- 代码质量优化

1. 重构登录组件为共享组件
2. User/Merchant继承BaseUserEntity
3. 清理TODO/FIXME/对齐原版等注释

---

## 八、统计汇总

| 类别 | P0 | P1 | P2 | 合计 |
|------|----|----|----|----|
| 买家中心缺失功能 | 3 | 6 | 4 | 13 |
| 商户中心缺失功能 | 6 | 8 | 2 | 16 |
| 管理后台缺失功能 | 2 | 7 | 3 | 12 |
| 流程中断点 | 5 | - | - | 5 |
| API未对齐 | 3 | 2 | - | 5 |
| 重复内容 | - | - | 4 | 4 |
| **合计** | **19** | **23** | **13** | **55** |

---

*报告生成时间：2026-01-09*
*审查工具：Claude Code*
