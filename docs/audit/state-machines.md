# 状态机锁定文档 (State Machines Lock)

> **版本**: v1.0
> **冻结日期**: 2026-01-04
> **约束级别**: LOCKED - 状态机定义不可修改，任何变更必须先更新此文档

---

## 总览

本文档汇总所有业务实体的状态机定义，作为重构版实现的唯一参考标准。

---

## 1. seller_task.status (商家任务状态)

### 状态定义

| 状态值 | 状态名 | 业务含义 |
|--------|--------|----------|
| 1 | 未支付 | 任务创建但未支付 |
| 2 | 已支付待审核 | 商家已支付等待后台审核 |
| 3 | 已通过 | 后台审核通过，可被领取 |
| 4 | 已拒绝 | 后台审核拒绝 |
| 5 | 已取消 | 商家取消任务 |
| 6 | 已完成 | 所有订单完成 |

### 状态转换矩阵

| 当前状态 | 目标状态 | 触发条件 | 触发角色 |
|----------|----------|----------|----------|
| 1 (未支付) | 2 (待审核) | 商家支付任务费用 | 商家 |
| 1 (未支付) | 5 (已取消) | 商家撤销任务 | 商家 |
| 2 (待审核) | 3 (已通过) | 后台审核通过 | 后台 |
| 2 (待审核) | 4 (已拒绝) | 后台审核拒绝 | 后台 |
| 3 (已通过) | 5 (已取消) | 商家取消（未被接单时） | 商家 |
| 3 (已通过) | 6 (已完成) | incomplete_num = 0 | 系统 |

### 禁止的状态转换

- 4 (已拒绝) → 任何状态
- 5 (已取消) → 任何状态
- 6 (已完成) → 任何状态
- 3 (已通过) → 5 (已取消) 当有订单时

---

## 2. user_task.state (买手订单状态)

### 状态定义

| 状态值 | 状态名 | 业务含义 |
|--------|--------|----------|
| 0 | 进行中 | 买手正在执行任务步骤 |
| 1 | 已完成 | 订单全流程完成 |
| 2 | 已取消 | 订单被取消 |
| 3 | 待发货 | 等待商家发货 |
| 4 | 待收货 | 已发货等待收货 |
| 5 | 待返款 | 等待商家返款 |
| 6 | 待确认返款 | 商家已返款待买手确认 |

### 状态转换矩阵

| 当前状态 | 目标状态 | 触发条件 | 触发角色 |
|----------|----------|----------|----------|
| 0 (进行中) | 2 (已取消) | 买手放弃/超时自动取消 | 买手/系统 |
| 0 (进行中) | 3 (待发货) | 买手完成步骤提交 | 买手 |
| 3 (待发货) | 2 (已取消) | 后台取消订单 | 后台 |
| 3 (待发货) | 4 (待收货) | 商家/后台发货 | 商家/后台 |
| 3 (待发货) | 5 (待返款) | 无需物流直接进入 | 系统 |
| 4 (待收货) | 5 (待返款) | 买手确认收货 | 买手 |
| 5 (待返款) | 6 (待确认返款) | 商家/后台返款 | 商家/后台 |
| 6 (待确认返款) | 1 (已完成) | 买手确认收款 | 买手/系统 |

### 禁止的状态转换

- 1 (已完成) → 任何状态
- 2 (已取消) → 任何状态
- 回退状态（如 4→3, 5→4）

---

## 3. user_task.delivery_state (发货状态)

### 状态定义

| 状态值 | 状态名 | 业务含义 |
|--------|--------|----------|
| 0 | 未发货 | 初始状态 |
| 1 | 已录入单号待发货 | 已填写快递单号 |
| 2 | 已发货 | 快递已揽收 |
| 3 | 已签收 | 买手已签收 |

### 状态转换矩阵

| 当前状态 | 目标状态 | 触发条件 | 触发角色 |
|----------|----------|----------|----------|
| 0 (未发货) | 1 (待发货) | 录入快递单号 | 商家/后台 |
| 0 (未发货) | 2 (已发货) | 直接发货（含单号） | 商家/后台 |
| 1 (待发货) | 2 (已发货) | 确认发货 | 商家/后台 |
| 2 (已发货) | 3 (已签收) | 确认收货 | 买手 |

---

## 4. seller_cash.state / user_cash.state (提现状态)

### 状态定义

| 状态值 | 状态名 | 业务含义 |
|--------|--------|----------|
| 0 | 已申请 | 提交提现申请 |
| 1 | 已同意 | 后台审核通过 |
| 2 | 已拒绝 | 后台审核拒绝 |
| 3 | 已返款 | 已完成打款 |

### 状态转换矩阵

| 当前状态 | 目标状态 | 触发条件 | 触发角色 |
|----------|----------|----------|----------|
| 0 (已申请) | 1 (已同意) | 后台审核通过 | 后台 |
| 0 (已申请) | 2 (已拒绝) | 后台审核拒绝 | 后台 |
| 1 (已同意) | 3 (已返款) | 后台完成打款 | 后台 |

### 特殊规则

- 拒绝时金额退回用户账户
- 已返款后需在 memo 记录打款单号

---

## 5. review_task.state (追评任务状态)

### 状态定义

| 状态值 | 状态名 | 业务含义 |
|--------|--------|----------|
| 0 | 未支付 | 追评任务已创建未支付 |
| 1 | 已支付 | 商家已支付追评费用 |
| 2 | 已审核 | 后台审核通过 |
| 3 | 已上传 | 买手已上传追评截图 |
| 4 | 已返款(已完成) | 追评佣金已返还 |
| 5 | 已取消 | 商家取消追评任务 |
| 6 | 买手拒接 | 买手拒绝执行追评 |
| 7 | 已拒绝 | 后台审核拒绝 |

### 状态转换矩阵

| 当前状态 | 目标状态 | 触发条件 | 触发角色 |
|----------|----------|----------|----------|
| 0 (未支付) | 1 (已支付) | 商家支付追评费用 | 商家 |
| 0 (未支付) | 5 (已取消) | 商家取消 | 商家 |
| 1 (已支付) | 2 (已审核) | 后台审核通过 | 后台 |
| 1 (已支付) | 5 (已取消) | 商家取消 | 商家 |
| 1 (已支付) | 7 (已拒绝) | 后台审核拒绝 | 后台 |
| 2 (已审核) | 3 (已上传) | 买手上传截图 | 买手 |
| 2 (已审核) | 6 (买手拒接) | 买手拒绝执行 | 买手 |
| 3 (已上传) | 4 (已返款) | 后台确认返款 | 后台 |

---

## 状态值对照表（重构版命名参考）

| 原版字段 | 原版状态值 | 建议重构版命名 |
|----------|-----------|---------------|
| seller_task.status=1 | 未支付 | UNPAID |
| seller_task.status=2 | 待审核 | PENDING_REVIEW |
| seller_task.status=3 | 已通过 | APPROVED |
| seller_task.status=4 | 已拒绝 | REJECTED |
| seller_task.status=5 | 已取消 | CANCELLED |
| seller_task.status=6 | 已完成 | COMPLETED |
| user_task.state=0 | 进行中 | IN_PROGRESS |
| user_task.state=1 | 已完成 | COMPLETED |
| user_task.state=2 | 已取消 | CANCELLED |
| user_task.state=3 | 待发货 | PENDING_SHIPMENT |
| user_task.state=4 | 待收货 | PENDING_RECEIPT |
| user_task.state=5 | 待返款 | PENDING_REFUND |
| user_task.state=6 | 待确认返款 | REFUND_PENDING_CONFIRM |

---

## 重构版实现约束

1. **状态值必须保持一致**：重构版的状态值（数字）必须与原版完全一致
2. **禁止合并状态**：不得将多个原版状态合并为一个
3. **禁止拆分状态**：不得将一个原版状态拆分为多个
4. **禁止新增状态**：不得在原有状态机上新增状态
5. **状态转换逻辑必须一致**：允许的转换路径必须与原版完全一致
