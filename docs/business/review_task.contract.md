# review_task 业务事实契约 (Business Contract)

> **版本**: v1.0
> **冻结日期**: 2026-01-04
> **数据来源**: 原版数据库 `tfkz_review_task` 表
> **约束级别**: LOCKED - 任何修改必须先更新此文档

---

## 表说明

追评任务表，存储买手订单完成后的追加评价任务信息。

---

## 字段契约

| 字段名 | 类型 | 必填 | 历史字段 | 业务语义 | 可修改端 | 备注 |
|--------|------|------|----------|----------|----------|------|
| `id` | int(11) | ✅ | ❌ | 主键ID | 系统 | 自增 |
| `seller_id` | int(11) | ✅ | ❌ | 商家ID | 系统 | 关联 seller.id |
| `user_id` | int(11) | ✅ | ❌ | 买手ID | 系统 | 关联 users.id |
| `buy_id` | int(11) | ✅ | ❌ | 买号ID | 系统 | 关联 user_buyno.id |
| `shop_id` | int(10) | ✅ | ❌ | 店铺ID | 系统 | 关联 shop.id |
| `taobao_number` | varchar(200) | ✅ | ❌ | 淘宝订单号 | 系统 | 来自原订单 |
| `pay_price` | decimal(12,2) | ✅ | ❌ | 买手支付金额 | 系统 | 原订单本金 |
| `task_number` | varchar(100) | ✅ | ❌ | 追评任务编号 | 系统 | 格式: ZP+时间戳 |
| `user_task_id` | varchar(300) | ✅ | ❌ | 买手任务单号 | 系统 | 关联 user_task.id |
| `task_id` | int(11) | ✅ | ❌ | 商家任务ID | 系统 | 关联 seller_task.id |
| `money` | decimal(12,2) | ✅ | ❌ | 商家支付金额 | 系统 | 追评任务总费用 |
| `user_money` | decimal(12,2) | ✅ | ❌ | 买手佣金 | 系统 | 追评佣金 |
| `create_time` | int(11) | ✅ | ❌ | 创建时间 | 系统 | 时间戳 |
| `img` | text | ❌ | ❌ | 追评截图 | 买手 | 追评好评截图URL |
| `upload_time` | int(11) | ❌ | ❌ | 上传时间 | 系统 | 买手上传截图时间 |
| `confirm_time` | int(11) | ❌ | ❌ | 完成时间 | 系统 | 时间戳 |
| `state` | tinyint(1) | ✅ | ❌ | **追评状态** | 后台/商家/买手 | 见状态机定义 |
| `pay_time` | int(10) | ✅ | ❌ | 支付时间 | 系统 | 商家支付时间 |
| `remarks` | text | ❌ | ❌ | 审核备注 | 后台 | 拒绝原因等 |
| `yjprice` | decimal(12,2) | ✅ | ❌ | 使用押金 | 系统 | 商家使用押金支付 |
| `ydprice` | decimal(12,2) | ✅ | ❌ | 使用银锭 | 系统 | 商家使用银锭支付 |
| `examine_time` | int(11) | ✅ | ❌ | 审核时间 | 后台 | 时间戳 |

---

## 状态机定义 (state)

```
0 (未支付) ─────────────────────────────────────────────────────────────────┐
     │                                                                       │
     ▼ [商家支付]                                                             │
1 (已支付) ──────────────────────────────────────────────────────────────────┤
     │                                                                       │
     ├──▶ [后台审核通过] ──▶ 2 (已审核) ────────────────────────────────────┐ │
     │                           │                                          │ │
     │                           └──▶ [买手上传截图] ──▶ 3 (已上传)          │ │
     │                                                       │              │ │
     │                                                       ▼              │ │
     │                                            [后台返款] ──▶ 4 (已返款)  │ │
     │                                                                      │ │
     └──▶ [后台拒绝] ──▶ 7 (已拒绝)                                          │ │
                                                                            │ │
5 (已取消) ◀── [商家取消]                                                    │ │
                                                                            │ │
6 (买手拒接) ◀── [买手拒绝]                                                  │ │
```

| 状态值 | 状态名 | 业务含义 | 允许的前置状态 | 触发角色 |
|--------|--------|----------|---------------|----------|
| 0 | 未支付 | 追评任务已创建未支付 | (初始) | 系统 |
| 1 | 已支付 | 商家已支付追评费用 | 0 | 商家 |
| 2 | 已审核 | 后台审核通过 | 1 | 后台 |
| 3 | 已上传 | 买手已上传追评截图 | 2 | 买手 |
| 4 | 已返款(已完成) | 追评佣金已返还给买手 | 3 | 后台 |
| 5 | 已取消 | 商家取消追评任务 | 0,1 | 商家 |
| 6 | 买手拒接 | 买手拒绝执行追评 | 1,2 | 买手 |
| 7 | 已拒绝 | 后台审核拒绝 | 1 | 后台 |

---

## 关联表

- `seller`: 商家表 (seller_id)
- `users`: 买手用户表 (user_id)
- `user_buyno`: 买号表 (buy_id)
- `shop`: 店铺表 (shop_id)
- `seller_task`: 商家任务表 (task_id)
- `user_task`: 买手订单表 (user_task_id)
- `review_task_praise`: 追评内容表

---

## 后台可修改字段

以下字段后台管理员有权限修改：

1. `state` - 审核状态 (1→2/7, 3→4)
2. `remarks` - 审核备注/拒绝原因
3. `examine_time` - 审核时间
4. `confirm_time` - 完成确认时间

---

## 金额说明

- `money` = 商家支付的追评总费用
- `user_money` = 买手获得的追评佣金
- `yjprice` = 商家使用押金支付金额
- `ydprice` = 商家使用银锭支付金额
- `pay_price` = 原订单买手支付金额（用于关联展示）

---

## 业务规则

1. 追评任务基于已完成的买手订单创建
2. 商家需先支付追评费用（押金或银锭）
3. 后台审核通过后买手可执行追评
4. 买手上传追评截图后等待返款
5. 返款完成后追评任务结束
6. 买手可拒绝执行追评任务
7. 商家可在未审核前取消追评任务
