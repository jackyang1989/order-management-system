# 诊断注册赠送银锭问题

## 问题描述
后台设置了注册赠送1银锭，但新用户注册后没有收到银锭。

## 诊断步骤

### 步骤1：检查数据库配置

```sql
-- 查看配置是否存在
SELECT * FROM system_configs WHERE `key` = 'user_register_reward';

-- 预期结果：
-- key: user_register_reward
-- value: 1 (或 "1")
-- valueType: number
```

**如果配置不存在**，执行：
```sql
INSERT INTO system_configs (`key`, `value`, `group`, `label`, `valueType`, `isEditable`, `isVisible`)
VALUES ('user_register_reward', '1', 'register', '买手注册赠送银锭', 'number', 1, 1);
```

**如果配置存在但值为0**，执行：
```sql
UPDATE system_configs SET `value` = '1' WHERE `key` = 'user_register_reward';
```

### 步骤2：重启后端服务

配置服务使用了缓存机制，需要重启后端服务来刷新缓存。

```bash
# 进入后端目录
cd backend

# 重启服务
npm run start:dev
# 或
pm2 restart backend
```

### 步骤3：检查服务启动日志

查看启动日志，确认配置已加载：

```bash
# 查看日志中是否有以下信息
# [AdminConfigService] 配置缓存已刷新，共 XX 项
```

### 步骤4：测试注册流程

1. 注册一个新用户
2. 检查用户表：

```sql
-- 查看最新注册的用户
SELECT id, username, phone, silver, reward, createdAt
FROM users
ORDER BY createdAt DESC
LIMIT 5;

-- 预期结果：
-- silver: 1
-- reward: 1
```

3. 检查财务流水：

```sql
-- 查看注册赠送流水
SELECT * FROM fund_records
WHERE description LIKE '%注册赠送%'
ORDER BY createdAt DESC
LIMIT 5;

-- 预期结果：
-- type: SILVER
-- action: IN
-- amount: 1
-- description: 首次注册赠送银锭
```

## 可能的问题原因

### 原因1：配置未保存到数据库

**症状**：数据库中查不到 `user_register_reward` 配置

**解决方案**：
- 手动插入配置（见步骤1）
- 或在后台管理界面重新保存配置

### 原因2：配置缓存未刷新

**症状**：数据库中配置正确，但新用户仍未收到银锭

**解决方案**：
- 重启后端服务（见步骤2）
- 或调用配置刷新接口（如果有）

### 原因3：前端传入了 silver 参数

**症状**：部分用户有银锭，部分没有

**代码位置**：[backend/src/users/users.service.ts:154](backend/src/users/users.service.ts#L154)

```typescript
const initialSilver = createUserDto.silver ?? registerSilver;
```

**说明**：
- 如果前端在注册时传入了 `silver` 字段，会优先使用前端值
- 只有前端未传入时，才使用配置值

**解决方案**：
- 检查前端注册代码，确保没有传入 `silver` 字段
- 或修改后端逻辑，强制使用配置值

### 原因4：配置值类型错误

**症状**：配置存在但值为字符串 `"0"` 或空字符串

**解决方案**：
```sql
-- 确保值为 "1"
UPDATE system_configs SET `value` = '1' WHERE `key` = 'user_register_reward';
```

## 验证修复

修复后，按以下步骤验证：

1. **清理测试数据**（可选）
```sql
-- 删除测试用户
DELETE FROM users WHERE username LIKE 'test%';
DELETE FROM fund_records WHERE userId IN (SELECT id FROM users WHERE username LIKE 'test%');
```

2. **注册新用户**
   - 使用测试手机号注册
   - 记录用户ID

3. **检查用户银锭**
```sql
SELECT id, username, silver, reward FROM users WHERE id = '用户ID';
```

4. **检查财务流水**
```sql
SELECT * FROM fund_records WHERE userId = '用户ID' AND description LIKE '%注册%';
```

5. **测试接单**
   - 登录新用户
   - 尝试接单
   - 应该能成功接单（扣除1银锭）

## 代码逻辑说明

### 注册赠送逻辑

**文件**：[backend/src/users/users.service.ts:152-188](backend/src/users/users.service.ts#L152-L188)

```typescript
// 1. 从配置中心读取赠送数量
const registerSilver = this.configService.getNumberValue('user_register_reward', 0);

// 2. 确定初始银锭（优先使用前端传入值）
const initialSilver = createUserDto.silver ?? registerSilver;

// 3. 创建用户时设置银锭
const newUser = this.usersRepository.create({
  silver: initialSilver,
  reward: initialSilver,
  // ...
});

// 4. 记录财务流水
if (registerSilver > 0) {
  await this.fundRecordRepository.save({
    userId: savedUser.id,
    type: FundType.SILVER,
    action: FundAction.IN,
    amount: registerSilver,
    balance: registerSilver,
    description: '首次注册赠送银锭',
  });
}
```

### 配置读取逻辑

**文件**：[backend/src/admin-config/admin-config.service.ts:138-141](backend/src/admin-config/admin-config.service.ts#L138-L141)

```typescript
getNumberValue(key: string, defaultValue: number = 0): number {
  const value = this.getValue(key);
  return value ? parseFloat(value) : defaultValue;
}
```

**说明**：
- 从缓存中读取配置值
- 如果配置不存在或为空，返回默认值0
- 自动将字符串转换为数字

### 配置初始化逻辑

**文件**：[backend/src/admin-config/admin-config.service.ts:19-22](backend/src/admin-config/admin-config.service.ts#L19-L22)

```typescript
async onModuleInit() {
  await this.ensureDefaultConfigs();
  await this.refreshCache();
}
```

**说明**：
- 服务启动时自动执行
- 确保默认配置存在
- 刷新配置缓存

## 快速修复命令

如果确认是配置问题，可以直接执行以下SQL：

```sql
-- 方案1：插入或更新配置
INSERT INTO system_configs (`key`, `value`, `group`, `label`, `valueType`, `isEditable`, `isVisible`, `sortOrder`)
VALUES ('user_register_reward', '1', 'register', '买手注册赠送银锭', 'number', 1, 1, 0)
ON DUPLICATE KEY UPDATE `value` = '1';

-- 方案2：如果已存在，只更新值
UPDATE system_configs SET `value` = '1' WHERE `key` = 'user_register_reward';
```

然后重启后端服务。

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. 数据库配置查询结果
2. 后端服务启动日志
3. 新注册用户的数据
4. 财务流水记录
5. 前端注册请求的payload

这将帮助进一步诊断问题。
