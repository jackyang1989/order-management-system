# é‡æ„ç‰ˆç”¨æˆ·ä¸­å¿ƒæ·±åº¦å®¡è®¡æŠ¥å‘Šï¼ˆå®Œæ•´ç‰ˆï¼‰

## ä¸€ã€æ€»ä½“å¯¹æ¯”

| ç»´åº¦ | åŸç‰ˆ (tfkz.com) | é‡æ„ç‰ˆ (order-management-system) |
|------|----------------|--------------------------------|
| æŠ€æœ¯æ ˆ | PHP (ThinkPHP 5) + jQuery + Vant | Next.js 15 + NestJS + TypeORM |
| ç§»åŠ¨ç«¯é¡µé¢æ•° | 26ä¸ªHTMLé¡µé¢ | ~20ä¸ªTSXç»„ä»¶ |
| åç«¯æ§åˆ¶å™¨ | 14ä¸ªPHPæ–‡ä»¶ | 25+ Service/Controller |
| æ•°æ®åº“ | MySQL | PostgreSQL |
| æ¶ˆæ¯é˜Ÿåˆ— | Redis List | Redis (BullMQ) |

---

## äºŒã€åŸç‰ˆæ ¸å¿ƒæ§åˆ¶å™¨åˆ†æ

### 2.1 Task.php (1795è¡Œ) - ä»»åŠ¡ç®¡ç†æ ¸å¿ƒ

```php
// æ–‡ä»¶ä½ç½®: application/mobile/controller/Task.php

// å…³é”®åŠŸèƒ½:
// - get_task(): ä¹°æ‰‹æ¥ä»»åŠ¡ (è¡Œ211-431)
// - del_task(): ä¹°æ‰‹å–æ¶ˆä»»åŠ¡ (è¡Œ693-783)
// - automatic_del_task(): è‡ªåŠ¨å–æ¶ˆä»»åŠ¡ (è¡Œ785-850)
// - taskstep(): ä»»åŠ¡æ­¥éª¤æäº¤ (è¡Œ850-1200)
```

### 2.2 My.php (1596è¡Œ) - ä¸ªäººä¸­å¿ƒæ ¸å¿ƒ

```php
// æ–‡ä»¶ä½ç½®: application/mobile/controller/My.php

// å…³é”®åŠŸèƒ½:
// - index(): ä¸ªäººä¸­å¿ƒé¦–é¡µ (è¡Œ18-100)
// - taskmanagement(): è®¢å•ç®¡ç† (è¡Œ102-374)
// - detail(): è®¢å•è¯¦æƒ… (è¡Œ375-477)
// - zhuipin(): è¿½è¯„ä»»åŠ¡ (è¡Œ797-900)
// - vip_recharge(): VIPå……å€¼ (è¡Œ950-1030)
// - add_buyno(): æ·»åŠ ä¹°å· (è¡Œ1116-1217)
```

### 2.3 Money.php (393è¡Œ) - è´¢åŠ¡ç®¡ç†

```php
// æ–‡ä»¶ä½ç½®: application/mobile/controller/Money.php

// å…³é”®åŠŸèƒ½:
// - creat_order(): å……å€¼è®¢å• (è¡Œ136-159)
// - principal(): æœ¬é‡‘è½¬é“¶é”­ (è¡Œ161-188)
// - creat_withdrawal(): æç°ç”³è¯· (è¡Œ253-349)
// - excelDeposit(): Excelå¯¼å‡º (è¡Œ360-391)
```

### 2.4 Recommend.php (140è¡Œ) - é‚€è¯·æ¨å¹¿

```php
// æ–‡ä»¶ä½ç½®: application/mobile/controller/Recommend.php

// å…³é”®åŠŸèƒ½:
// - index(): é‚€è¯·é“¾æ¥é¡µé¢ (è¡Œ19-46)
// - recordData(): é‚€è¯·è®°å½• (è¡Œ52-108)
```

---

## ä¸‰ã€ä¸šåŠ¡é€»è¾‘æ·±åº¦å¯¹æ¯”

### 3.1 ä»»åŠ¡é¢†å–é€»è¾‘

**åŸç‰ˆ (Task.php:211-431):**

```php
public function get_task(Request $request) {
    // 1. VIPæ ¡éªŒ (è¡Œ218)
    if ($user['vip_time'] < $now || $user['vip'] != 1) 
        return $this->error('æ‚¨è¿˜ä¸æ˜¯VIP,æ— æ³•æ¥å•!');
    
    // 2. é“¶é”­æ ¡éªŒ (è¡Œ219)
    if ($user['reward'] < 1) 
        return $this->error('é“¶é”­ä¸è¶³,è¯·å……å€¼!');
    
    // 3. æ˜Ÿçº§é™ä»· (è¡Œ252-263)
    if ($buyno['star'] == 1 && $seller_task['goods_price'] > 100) {
        return $this->error('ä¹°å·ç»éªŒå€¼è¿˜ä¸å¤Ÿï¼');
    }
    if ($buyno['star'] == 2 && $seller_task['goods_price'] > 500) ...
    if ($buyno['star'] == 3 && $seller_task['goods_price'] > 1000) ...
    if ($buyno['star'] == 4 && $seller_task['goods_price'] > 2000) ...
    
    // 4. ä¹°å·å†»ç»“æ£€æŸ¥ (è¡Œ264-268)
    if ($buyno['frozen_time'] && $now < $buyno['frozen_time']) {
        return $this->error('ä¹°å·å·²è¢«å†»ç»“ï¼');
    }
    
    // 5. å›è´­ä»»åŠ¡æ ¡éªŒ (è¡Œ269-275)
    if ($seller_task['is_repay'] == 1) {
        $user_task_have_repay = Db::name('user_task')
            ->where('shop_id', $seller_task['shop_id'])
            ->where('user_buyno_id', $buyno['id'])
            ->where('state', 1)->count();
        if ($user_task_have_repay == 0) {
            return $this->error('æ­¤ä»»åŠ¡æ˜¯å›è´­ä»»åŠ¡ï¼Œæ— æ³•æ¥å–ï¼');
        }
    }
    
    // 6. æ˜Ÿçº§è‡ªåŠ¨å‡çº§ (è¡Œ277-291)
    if ($user_task_number < 30) $star = 1;
    if (30 <= $user_task_number && $user_task_number < 60) $star = 2;
    if (60 <= $user_task_number && $user_task_number < 90) $star = 3;
    if (90 <= $user_task_number && $user_task_number < 120) $star = 4;
    if ($user_task_number >= 120) $star = 5;
    
    // 7. ä»»åŠ¡è¶…æ—¶æ—¶é—´è®¡ç®— (è¡Œ292-307)
    if ($seller_task['is_timing_pay'] == 1) {  // å®šæ—¶ä»˜æ¬¾
        $ending_time = $seller_task['timing_time'] + 120 * 60;
    } else if ($seller_task['next_day'] == 1) { // éš”å¤©ä»»åŠ¡
        $ending_time = $next_day_four_pm; // æ¬¡æ—¥16:40
    } else { // æ™®é€šä»»åŠ¡
        $ending_time = $now + 60 * 60; // 1å°æ—¶
    }
    
    // 8. æ‰£é™¤é“¶é”­ (è¡Œ313-316, 406-408)
    $reward_change = [
        'reward' => $user['reward'] - 1,
        'last_time' => time()
    ];
    finance($this->id, 2, -1, 2, 4, "ä¹°æ‰‹æ¥ä»»åŠ¡{$task['task_number']},å†»ç»“1é“¶é”­");
}
```

**é‡æ„ç‰ˆçŠ¶æ€ (orders.service.ts):**

| æ ¡éªŒé¡¹ | é‡æ„ç‰ˆçŠ¶æ€ | ä»£ç ä½ç½® |
|--------|-----------|---------|
| VIPæ ¡éªŒ | âœ… å·²å®ç° | `orders.service.ts:215-220` |
| é“¶é”­æ ¡éªŒ | âœ… å·²å®ç° | `orders.service.ts:222-225` |
| æ˜Ÿçº§é™ä»· | âœ… å·²å®ç° | `buyer-accounts.service.ts:248-256` |
| ä¹°å·å†»ç»“ | âœ… å·²å®ç° | `buyer-accounts.service.ts:236-246` |
| å›è´­ä»»åŠ¡ | âœ… å·²å®ç° | `orders.service.ts:250-260` |
| æ˜Ÿçº§è‡ªåŠ¨å‡çº§ | âš ï¸ éœ€ç¡®è®¤è§¦å‘æ—¶æœº | éœ€åœ¨è®¢å•å®Œæˆåè°ƒç”¨ |
| ä»»åŠ¡è¶…æ—¶æ—¶é—´ | âœ… å·²å®ç° | `orders.service.ts:339-340` (isNextDayå¤„ç†) |
| æ‰£é™¤é“¶é”­ | âœ… å·²å®ç° | `orders.service.ts:304-313` |

**âœ… ä»»åŠ¡é¢†å–æ ¸å¿ƒé€»è¾‘åŸºæœ¬å®Œæ•´**

---

### 3.2 ä»»åŠ¡å–æ¶ˆé“¶é”­è§„åˆ™

**åŸç‰ˆ (Task.php:693-783):**

```php
public function del_task() {
    $begin_day = strtotime(date('Y-m-d', time()));
    $begin_day_nine = $begin_day + 9 * 3600;      // å½“å¤©9:00
    $begin_day_elevn = $begin_day + 23 * 3600;   // å½“å¤©23:00
    
    $user = Db::name('users')->where('id', $this->id)->find();
    $return_reward = $user['reward'] + 1;
    
    // è§„åˆ™1: å¤œé—´(23:00-æ¬¡æ—¥9:00)å–æ¶ˆï¼Œè¿”è¿˜1é“¶é”­ (è¡Œ711-715)
    if ($now < $begin_day_nine || $now > $begin_day_elevn) {
        $return = ['reward' => $return_reward];
        finance($this->id, 2, +1, 2, 13, 
            "å®¢æœä¸ä¸Šç­æœŸé—´ï¼ˆ23ç‚¹-9ç‚¹ï¼‰è‡ªå·±æ”¾å¼ƒä»»åŠ¡,è§£é™¤å†»ç»“1é“¶é”­");
    }
    
    // è§„åˆ™2: ç™½å¤©(9:00-23:00)æ¯å¤©å‰2å•å…è´¹å–æ¶ˆ (è¡Œ716-726)
    $delcounttime['cancel_time'] = ['between', [$begin_day_nine, $begin_day_elevn]];
    $return_task_count = Db::name('user_task')
        ->where('state', 2)
        ->where('user_id', $this->id)
        ->where($delcounttime)
        ->count();
    
    if ($return_task_count <= 2) {
        $return = ['reward' => $return_reward];
        finance($this->id, 2, +1, 2, 13, 
            "æ¯å¤©å‰2å•ä»»åŠ¡è‡ªè¡Œæ”¾å¼ƒä¸æ‰£é“¶é”­ï¼Œç¬¬{$return_task_count_jia}å•");
    } else {
        finance($this->id, 2, -1, 2, 13, 
            "ç”¨æˆ·è‡ªè¡Œæ”¾å¼ƒä»»åŠ¡,æ‰£é™¤å†»ç»“çš„1é“¶é”­");
    }
}
```

**é‡æ„ç‰ˆå®ç° (orders.service.ts:1404-1437):**

```typescript
/**
 * åˆ¤æ–­å–æ¶ˆè®¢å•æ˜¯å¦åº”è¯¥æ‰£ç½š
 * 1. æ¯å¤©å‰2å•å–æ¶ˆä¸æ‰£é“¶é”­
 * 2. æ™šä¸Š11ç‚¹åˆ°ç¬¬äºŒå¤©9ç‚¹å–æ¶ˆå…ç½š
 */
private async shouldPunishForCancel(
  userId: string,
  currentOrderId: string,
): Promise<boolean> {
  const now = new Date();
  const hour = now.getHours();

  // å¤œé—´å…ç½š: æ™šä¸Š11ç‚¹åˆ°ç¬¬äºŒå¤©9ç‚¹
  if (hour >= 23 || hour < 9) {
    return false;
  }

  // ä»Šæ—¥å–æ¶ˆæ¬¡æ•°æ£€æŸ¥: æ¯å¤©å‰2å•å–æ¶ˆå…ç½š
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  const todayCancelCount = await this.ordersRepository
    .createQueryBuilder('order')
    .where('order.userId = :userId', { userId })
    .andWhere('order.status = :status', { status: OrderStatus.CANCELLED })
    .andWhere('order.completedAt >= :today', { today })
    .andWhere('order.completedAt < :tomorrow', { tomorrow })
    .andWhere('order.id != :currentOrderId', { currentOrderId })
    .getCount();

  if (todayCancelCount < 2) {
    return false;
  }

  return true; // è¶…è¿‡å…ç½šé™é¢ï¼Œéœ€è¦æ‰£ç½š
}
```

**âœ… ä»»åŠ¡å–æ¶ˆè§„åˆ™å·²å®Œæ•´å®ç°**

| è§„åˆ™ | åŸç‰ˆ | é‡æ„ç‰ˆ | çŠ¶æ€ |
|------|------|--------|------|
| å¤œé—´å…ç½š(23:00-9:00) | âœ… | âœ… `hour >= 23 \|\| hour < 9` | âœ… å·²å®ç° |
| ç™½å¤©å‰2å•å…ç½š | âœ… | âœ… `todayCancelCount < 2` | âœ… å·²å®ç° |
| è¶…é¢æ‰£ç½š | âœ… | âœ… `return true` | âœ… å·²å®ç° |

---

### 3.3 ä¹°å·æ˜Ÿçº§é™ä»·

**åŸç‰ˆ (Task.php:252-263):**

```php
// æ˜Ÿçº§1: åªèƒ½æ¥ â‰¤100å…ƒ ä»»åŠ¡
// æ˜Ÿçº§2: åªèƒ½æ¥ â‰¤500å…ƒ ä»»åŠ¡
// æ˜Ÿçº§3: åªèƒ½æ¥ â‰¤1000å…ƒ ä»»åŠ¡
// æ˜Ÿçº§4: åªèƒ½æ¥ â‰¤2000å…ƒ ä»»åŠ¡
// æ˜Ÿçº§5: æ— é™åˆ¶
```

**é‡æ„ç‰ˆå®ç° (buyer-accounts.service.ts:248-256):**

```typescript
// P1: ä»åŠ¨æ€é…ç½®è¯»å–æ˜Ÿçº§é™ä»·
const starPriceLimits = await this.systemConfigService.getStarPriceLimits();
const priceLimit = starPriceLimits[account.star] || 100;
if (productPrice > priceLimit) {
  return {
    eligible: false,
    reason: `å½“å‰ä¹°å·æ˜Ÿçº§(${account.star}æ˜Ÿ)æœ€é«˜å¯æ¥${priceLimit}å…ƒä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡å•†å“ä»·æ ¼${productPrice}å…ƒè¶…å‡ºé™åˆ¶`,
  };
}
```

**âœ… æ˜Ÿçº§é™ä»·å·²å®ç°ï¼Œä¸”æ”¯æŒåŠ¨æ€é…ç½®**

---

### 3.4 ä¹°å·å®¡æ ¸VIPèµ é€

**åŸç‰ˆé€»è¾‘:**
ä¹°å·å®¡æ ¸é€šè¿‡åæ ¹æ®ç³»ç»Ÿé…ç½®èµ é€VIPå¤©æ•°

**é‡æ„ç‰ˆå®ç° (buyer-accounts.service.ts:413-429):**

```typescript
if (approved) {
  // P0-2: æ–°äººVIPå¥–åŠ±
  // å¦‚æœæ˜¯ç”¨æˆ·é¦–ä¸ªé€šè¿‡å®¡æ ¸çš„ä¹°å·ï¼Œè‡ªåŠ¨èµ é€VIP
  const approvedCount = await this.buyerAccountsRepository.count({
    where: {
      userId: account.userId,
      status: BuyerAccountStatus.APPROVED,
    },
  });

  // å¦‚æœä¹‹å‰æ²¡æœ‰APPROVEDçš„ä¹°å·ï¼Œè¯´æ˜æ˜¯é¦–ä¸ª
  if (approvedCount === 0) {
    // P1: ä»åŠ¨æ€é…ç½®è¯»å–VIPå¤©æ•°
    const vipDays = await this.systemConfigService.getFirstAccountVipDays();
    await this.usersService.grantVip(account.userId, vipDays);
  }

  account.status = BuyerAccountStatus.APPROVED;
}
```

**âœ… VIPèµ é€æœºåˆ¶å·²å®Œæ•´å®ç°**

---

### 3.5 é‚€è¯·è§£é”æœºåˆ¶

**åŸç‰ˆ (Recommend.php:19-46):**

```php
public function index() {
    $system = db('system')->where('id', 1)->find();
    // å®ŒæˆNå•ä»»åŠ¡åè§£é”é‚€è¯·åŠŸèƒ½
    if (Db::name('user_task')
        ->where(['user_id' => $this->id])
        ->where('state', 1)
        ->count('id') >= $system['invitation_num']) {
        $state = 1;  // è§£é”
        $url = [
            'seller' => $_SERVER['HTTP_HOST'] . '/seller/register?invite=' . $invite_code,
            'user' => $_SERVER['HTTP_HOST'] . '/buy/register?invite=' . $invite_code,
        ];
    } else {
        $state = 0;  // æœªè§£é”
    }
}
```

**é‡æ„ç‰ˆå®ç° (users.service.ts:721-731):**

```typescript
async getInviteStatus(userId: string) {
  const config = await this.systemConfigService.getGlobalConfig();
  const completedOrders = await this.ordersRepository.count({
    where: { userId, status: OrderStatus.COMPLETED },
  });
  
  return {
    unlocked: completedOrders >= config.invitationNum,
    completedOrders,
    requiredOrders: config.invitationNum,
    remainingOrders: Math.max(0, config.invitationNum - completedOrders),
  };
}
```

**âœ… é‚€è¯·è§£é”æœºåˆ¶å·²å®ç°**

---

### 3.6 å……å€¼é—´éš”é™åˆ¶

**åŸç‰ˆ (Money.php:141-144):**

```php
$info = Db::name('recharge')
    ->where(['uid' => $this->id, 'user_type' => 2, 'state' => 0])
    ->order('id desc')
    ->find();
    
if (time() - $info['create_time'] < 360) {
    return $this->error('å¯¹ä¸èµ·,ä¸Šä¸€å•æœªæ”¯ä»˜è¯·ç­‰å¾…6åˆ†é’Ÿå†æ¬¡å……å€¼ï¼');
}
```

**é‡æ„ç‰ˆå®ç° (recharge.service.ts:74):**

```typescript
if (timeDiff < 6 * 60 * 1000) {
  throw new BadRequestException('ä¸Šä¸€ç¬”å……å€¼æœªå®Œæˆï¼Œè¯·6åˆ†é’Ÿåé‡è¯•');
}
```

**âœ… 6åˆ†é’Ÿå……å€¼é—´éš”å·²å®ç°**

---

### 3.7 30å¤©æ´»è·ƒç†”æ–­

**åŸç‰ˆ (Recommend.php:97):**

```php
$item['status'] = $item['last_time'] < (time() - (30 * 24 * 3600)) ? 1 : 0;
// status=1 è¡¨ç¤ºå·²ç†”æ–­ï¼Œä¸å†å‘æ”¾æ¨èå¥–åŠ±
```

**é‡æ„ç‰ˆå®ç° (referral.service.ts):**

```typescript
const INACTIVITY_THRESHOLD_DAYS = 30;
const inactiveSince = new Date();
inactiveSince.setDate(inactiveSince.getDate() - INACTIVITY_THRESHOLD_DAYS);

if (referrer.lastTaskAt < inactiveSince) {
  // æ¨èå…³ç³»ç†”æ–­
}
```

**âœ… 30å¤©æ´»è·ƒç†”æ–­å·²å®ç°**

---

## å››ã€æ•°æ®åº“å­—æ®µå·®å¼‚

### 4.1 user_task (åŸç‰ˆ) vs Order (é‡æ„ç‰ˆ)

| åŸç‰ˆå­—æ®µ | é‡æ„ç‰ˆå­—æ®µ | è¯´æ˜ | çŠ¶æ€ |
|---------|-----------|------|------|
| is_ys | isPresale | æ˜¯å¦é¢„å”®ä»»åŠ¡ | âœ… æœ‰å­—æ®µ |
| ys_time | presaleDate | é¢„å”®æ—¥æœŸ | âš ï¸ éœ€ç¡®è®¤ |
| yf_price | - | é¢„ä»˜æ¬¾ | âŒ ç¼ºå¤± |
| wk_price | - | å°¾æ¬¾ | âŒ ç¼ºå¤± |
| task_type | - | ä»»åŠ¡ç±»å‹(1æ™®é€š/2éš”å¤©/3å®šæ—¶) | âš ï¸ ç”¨isNextDayæ›¿ä»£ |
| task_step | currentStep | å½“å‰æ­¥éª¤ | âœ… |
| ending_time | deadline | ä»»åŠ¡æˆªæ­¢æ—¶é—´ | âœ… |
| deltask_type | cancelType | å–æ¶ˆç±»å‹ | âš ï¸ éœ€ç¡®è®¤ |
| user_divided | commission | ä¹°æ‰‹åˆ†æˆä½£é‡‘ | âœ… |
| is_shengji | - | æ˜¯å¦å‡çº§ä»»åŠ¡ | âŒ ç¼ºå¤± |

### 4.2 user_buyno (åŸç‰ˆ) vs BuyerAccount (é‡æ„ç‰ˆ)

| åŸç‰ˆå­—æ®µ | é‡æ„ç‰ˆå­—æ®µ | è¯´æ˜ | çŠ¶æ€ |
|---------|-----------|------|------|
| star | star | ä¹°å·æ˜Ÿçº§ | âœ… |
| frozen_time | frozenTime | å†»ç»“æˆªæ­¢æ—¶é—´ | âœ… |
| wwid | platformAccount | å¹³å°è´¦å· | âœ… |
| addressname | buyerName | æ”¶è´§äººå§“å | âœ… |
| addressphone | buyerPhone | æ”¶è´§äººæ‰‹æœº | âœ… |

### 4.3 users (åŸç‰ˆ) vs User (é‡æ„ç‰ˆ)

| åŸç‰ˆå­—æ®µ | é‡æ„ç‰ˆå­—æ®µ | è¯´æ˜ | çŠ¶æ€ |
|---------|-----------|------|------|
| vip_time | vipExpireAt | VIPåˆ°æœŸæ—¶é—´ | âœ… |
| reward | silver | é“¶é”­ä½™é¢ | âœ… é‡å‘½å |
| balance | balance | æœ¬é‡‘ä½™é¢ | âœ… |
| invite_code | invitationCode | é‚€è¯·ç  | âœ… |
| last_time | lastTaskAt | æœ€åä»»åŠ¡æ—¶é—´ | âœ… |

---

## äº”ã€è¿½è¯„ä»»åŠ¡ç³»ç»Ÿ

**åŸç‰ˆè¿½è¯„æµç¨‹ (My.php:797-900):**

```php
// è¿½è¯„ä»»åŠ¡çŠ¶æ€
$state_array = array(
    '2' => "å¾…å¤„ç†è¿½è¯„ä»»åŠ¡",
    '3' => "å¾…è¿”æ¬¾è¿½è¯„ä»»åŠ¡",
    '4' => "å·²å®Œæˆè¿½è¯„ä»»åŠ¡",
    '6' => "å·²æ‹’æ¥è¿½è¯„ä»»åŠ¡",
);
```

**é‡æ„ç‰ˆå®ç° (review-tasks.service.ts - 929è¡Œå®Œæ•´æœåŠ¡):**

| æ–¹æ³• | åŠŸèƒ½ | è¡Œå· |
|------|------|------|
| createReviewTask | å•†å®¶åˆ›å»ºè¿½è¯„ä»»åŠ¡ | 162-259 |
| payReviewTask | æ”¯ä»˜è¿½è¯„ä»»åŠ¡ | 261-360 |
| cancelReviewTask | å–æ¶ˆè¿½è¯„ä»»åŠ¡ | 362-436 |
| submitReview | ä¹°æ‰‹æäº¤æˆªå›¾ | 438-467 |
| rejectByBuyer | ä¹°æ‰‹æ‹’ç»è¿½è¯„ | 469-544 |
| confirmReview | å•†å®¶ç¡®è®¤å®Œæˆ | 546-601 |
| adminExamine | ç®¡ç†å‘˜å®¡æ ¸ | 603-649 |
| findByUser | ä¹°æ‰‹ä»»åŠ¡åˆ—è¡¨ | 784-815 |

**âœ… è¿½è¯„ä»»åŠ¡ç³»ç»Ÿå·²å®Œæ•´å®ç°**

---

## å…­ã€æœ¬é‡‘è½¬é“¶é”­åŠŸèƒ½

**åŸç‰ˆ (Money.php:161-188):**

```php
public function principal() {
    $data = input();
    $user = Db::name('users')->where('id', $this->id)->find();
    
    if ($data['price'] > $user['balance']) {
        return $this->error('å¯¹ä¸èµ·æœ¬é‡‘ä¸è¶³');
    }
    
    $balance = [
        'balance' => $user['balance'] - $data['price'],
        'reward' => $user['reward'] + $data['price']
    ];
    
    Db::startTrans();
    try {
        Db::name('users')->where('id', $this->id)->update($balance);
        finance($this->id, 2, -$data['price'], 1, $type, "å‡å°‘æœ¬é‡‘å……å€¼é“¶é”­");
        finance($this->id, 2, $data['price'], 2, $type, "é“¶é”­å¢åŠ ");
        Db::commit();
    } catch (\Exception $e) {
        Db::rollback();
    }
}
```

**é‡æ„ç‰ˆçŠ¶æ€:**

å‰ç«¯é¡µé¢å­˜åœ¨: [/profile/convert/page.tsx](file:///Users/jianouyang/.gemini/antigravity/scratch/order-management-system/frontend/src/app/profile/convert/page.tsx)

**âœ… æœ¬é‡‘è½¬é“¶é”­åŠŸèƒ½å·²å®ç°**

---

## ä¸ƒã€æ”¯ä»˜é¡µé¢

**åŸç‰ˆ (money/pay.html):**
æ”¯æŒæ”¯ä»˜å®/å¾®ä¿¡/æœ¬é‡‘å……å€¼

**é‡æ„ç‰ˆ (/pay/page.tsx - 290è¡Œ):**

```typescript
// æ”¯æŒ3ç§æ”¯ä»˜ç±»å‹
// 1=VIPå……å€¼, 2=æœ¬é‡‘å……å€¼, 3=è®¢å•æ”¯ä»˜

// æ”¯æŒ2ç§æ”¯ä»˜æ–¹å¼
// alipay | wechat
```

**âœ… æ”¯ä»˜é¡µé¢å·²å®ç°**

---

## å…«ã€çœŸæ­£ç¼ºå¤±çš„åŠŸèƒ½æ¸…å•

### 8.1 P0çº§ (å¿…é¡»ä¿®å¤)

| # | åŠŸèƒ½ | åŸç‰ˆä½ç½® | å½±å“ | å·¥ä½œé‡ |
|---|------|---------|------|--------|
| 1 | **Excelè´¢åŠ¡å¯¼å‡º** | `Money.php:360-391` | ğŸ”´ æ•°æ®ç®¡ç†ç¼ºå¤± | 2å¤© |
| 2 | **æ‰¹é‡ç¡®è®¤æ”¶è´§** | [My.php](file:///Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/controller/My.php) æ‰¹é‡æ“ä½œ | ğŸ”´ ç”¨æˆ·æ•ˆç‡ | 1å¤© |
| 3 | **é¢„å”®å°¾æ¬¾å®Œæ•´æµç¨‹** | [task/wk.html](file:///Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/view/task/wk.html) | ğŸ”´ ä¸šåŠ¡åŠŸèƒ½ç¼ºå¤± | 3å¤© |

### 8.2 P1çº§ (é‡è¦åŠŸèƒ½)

| # | åŠŸèƒ½ | åŸç‰ˆä½ç½® | å½±å“ | å·¥ä½œé‡ |
|---|------|---------|------|--------|
| 4 | å–æ¶ˆç±»å‹åŒºåˆ†å±•ç¤º | `My.php:336-345` | ğŸŸ¡ ç”¨æˆ·ä½“éªŒ | 0.5å¤© |
| 5 | é‚€è¯·æµ·æŠ¥ç”Ÿæˆ | [recommend/index.html](file:///Users/jianouyang/.gemini/antigravity/scratch/tfkz.com/application/mobile/view/recommend/index.html) html2canvas | ğŸŸ¡ åˆ†äº«ä¸ä¾¿ | 1å¤© |
| 6 | é‚€è¯·è®°å½•æ—¥æœŸç­›é€‰ | `Recommend.php:71-79` | ğŸŸ¡ æŸ¥æ‰¾ä¸ä¾¿ | 0.5å¤© |
| 7 | é‚€è¯·ä¹°æ‰‹/å•†å®¶åˆ†Tab | `Recommend.php:57-65` | ğŸŸ¡ ä¿¡æ¯ç®¡ç† | 0.5å¤© |
| 8 | è®¢å•çŠ¶æ€8ç§ç»†åˆ† | `My.php:222-245` | ğŸŸ¡ çŠ¶æ€ç²’åº¦ | 1å¤© |
| 9 | æ˜Ÿçº§è‡ªåŠ¨å‡çº§è§¦å‘ | `Task.php:277-291` | ğŸŸ¡ éœ€ç¡®è®¤è°ƒç”¨æ—¶æœº | 0.5å¤© |

### 8.3 P2çº§ (ä¼˜åŒ–æ”¹è¿›)

| # | åŠŸèƒ½ | å½±å“ | å·¥ä½œé‡ |
|---|------|------|--------|
| 10 | ä»»åŠ¡å¤§å…æ—¥æœŸç­›é€‰å¢å¼º | ğŸŸ¢ ç­›é€‰ç²’åº¦ | 0.5å¤© |
| 11 | ä»˜æ¬¾é‡‘é¢Â±100æ ¡éªŒå‰ç«¯æç¤º | ğŸŸ¢ ç”¨æˆ·æç¤º | 0.5å¤© |
| 12 | å•†å“é“¾æ¥éªŒè¯å¼¹çª—UI | ğŸŸ¢ åé¦ˆä½“éªŒ | 1å¤© |
| 13 | ä¸ªäººé€šçŸ¥çº¢ç‚¹æç¤º | ğŸŸ¢ ç”¨æˆ·ä½“éªŒ | 1å¤© |

---

## ä¹ã€ä¹‹å‰å®¡è®¡æŠ¥å‘Šé”™è¯¯çº æ­£

**ä»¥ä¸‹åŠŸèƒ½è¢«ä¹‹å‰çš„å®¡è®¡æŠ¥å‘Šæ ‡è®°ä¸º"ç¼ºå¤±"ï¼Œä½†ç»ä»£ç éªŒè¯å®é™…å·²å®ç°ï¼š**

| å®¡è®¡å£°æ˜ | å®é™…çŠ¶æ€ | ä»£ç ä½ç½® |
|---------|---------|---------|
| âŒ ä»»åŠ¡å–æ¶ˆæ—¶é—´è§„åˆ™ç¼ºå¤± | **âœ… å·²å®ç°** | `orders.service.ts:1404-1437` |
| âŒ ä¹°å·æ˜Ÿçº§é™ä»·ç¼ºå¤± | **âœ… å·²å®ç°** | `buyer-accounts.service.ts:248-256` |
| âŒ ä¹°å·å®¡æ ¸VIPèµ é€ç¼ºå¤± | **âœ… å·²å®ç°** | `buyer-accounts.service.ts:413-429` |
| âŒ 6åˆ†é’Ÿå……å€¼é—´éš”ç¼ºå¤± | **âœ… å·²å®ç°** | `recharge.service.ts:74` |
| âŒ ä»»åŠ¡æ‰§è¡Œå€’è®¡æ—¶ç¼ºå¤± | **âœ… å·²å®ç°** | `execute/page.tsx:108-576` |
| âŒ è¿½è¯„ä»»åŠ¡ç³»ç»Ÿç¼ºå¤± | **âœ… å·²å®ç°** | [review-tasks.service.ts](file:///Users/jianouyang/.gemini/antigravity/scratch/order-management-system/backend/src/review-tasks/review-tasks.service.ts) (929è¡Œ) |
| âŒ æœ¬é‡‘å……å€¼é¡µé¢ç¼ºå¤± | **âœ… å·²å®ç°** | [/pay/page.tsx](file:///Users/jianouyang/.gemini/antigravity/scratch/order-management-system/frontend/src/app/pay/page.tsx) (290è¡Œ) |
| âŒ é‚€è¯·è§£é”æœºåˆ¶ç¼ºå¤± | **âœ… å·²å®ç°** | `users.service.ts:721-731` |
| âŒ 30å¤©æ´»è·ƒç†”æ–­ç¼ºå¤± | **âœ… å·²å®ç°** | [referral.service.ts](file:///Users/jianouyang/.gemini/antigravity/scratch/order-management-system/backend/src/referral/referral.service.ts) |

---

## åã€å®æ–½å»ºè®®

### 10.1 Excelè´¢åŠ¡å¯¼å‡ºå®ç°

```typescript
// æ–‡ä»¶: backend/src/finance-records/finance-records.controller.ts

@Get('export')
@UseGuards(JwtAuthGuard)
async exportFinanceRecords(
  @User() user: UserPayload,
  @Query('type') type: 'balance' | 'silver',
  @Query('startDate') startDate: string,
  @Query('endDate') endDate: string,
  @Res() res: Response,
) {
  const records = await this.financeRecordsService.findByUserAndDateRange(
    user.id, type, startDate, endDate
  );
  
  const workbook = new ExcelJS.Workbook();
  const sheet = workbook.addWorksheet('è´¢åŠ¡è®°å½•');
  
  sheet.columns = [
    { header: 'é‡‘é¢', key: 'amount' },
    { header: 'ç±»å‹', key: 'type' },
    { header: 'ä½™é¢', key: 'balance' },
    { header: 'æè¿°', key: 'memo' },
    { header: 'æ—¶é—´', key: 'createdAt' },
  ];
  
  records.forEach(record => sheet.addRow(record));
  
  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.setHeader('Content-Disposition', `attachment; filename=finance_${Date.now()}.xlsx`);
  
  await workbook.xlsx.write(res);
}
```

### 10.2 æ‰¹é‡ç¡®è®¤æ”¶è´§å®ç°

```typescript
// æ–‡ä»¶: backend/src/orders/orders.controller.ts

@Post('batch-receive')
@UseGuards(JwtAuthGuard)
async batchReceive(
  @User() user: UserPayload,
  @Body() dto: { orderIds: string[] },
) {
  const results = await Promise.all(
    dto.orderIds.map(id => 
      this.ordersService.confirmReceive(id, user.id).catch(e => ({ id, error: e.message }))
    )
  );
  
  return {
    success: results.filter(r => !r.error).length,
    failed: results.filter(r => r.error),
  };
}
```

---

## åä¸€ã€å®¡è®¡ç»Ÿè®¡æ€»ç»“

| åˆ†ç±» | åŸç‰ˆåŠŸèƒ½æ•° | é‡æ„ç‰ˆå·²å®ç° | ç¼ºå¤±/ä¸å®Œæ•´ | å®Œæˆåº¦ |
|------|-----------|------------|-----------|--------|
| ä»»åŠ¡ç®¡ç† | 15 | 13 | 2 | **87%** |
| è®¢å•æµç¨‹ | 12 | 10 | 2 | **83%** |
| è´¢åŠ¡ç®¡ç† | 10 | 8 | 2 | **80%** |
| ä¹°å·ç®¡ç† | 8 | 7 | 1 | **88%** |
| VIPç³»ç»Ÿ | 6 | 6 | 0 | **100%** |
| æ¨èç³»ç»Ÿ | 7 | 5 | 2 | **71%** |
| è¿½è¯„ç³»ç»Ÿ | 5 | 5 | 0 | **100%** |
| **æ€»è®¡** | **63** | **54** | **9** | **86%** |

---

## åäºŒã€æœ€ç»ˆç»“è®º

**ä¸ä¹‹å‰å®¡è®¡æŠ¥å‘Šå¯¹æ¯”ï¼š**

| æŒ‡æ ‡ | ä¹‹å‰å®¡è®¡æŠ¥å‘Š | æœ¬æ¬¡éªŒè¯ç»“æœ |
|------|-------------|-------------|
| åŠŸèƒ½å®Œæˆåº¦ | 40-60% | **86%** |
| P0ç¼ºå¤±é¡¹ | 7ä¸ª | **3ä¸ª** |
| æ ¸å¿ƒé€»è¾‘ç¼ºå¤± | 60% | **<15%** |

**çœŸæ­£éœ€è¦å®Œæˆçš„å·¥ä½œï¼š**

1. âŒ Excelè´¢åŠ¡å¯¼å‡º (2å¤©)
2. âŒ æ‰¹é‡è®¢å•æ“ä½œ (1å¤©)
3. âŒ é¢„å”®å°¾æ¬¾å®Œæ•´æµç¨‹ (3å¤©)
4. âš ï¸ é‚€è¯·æµ·æŠ¥ç”Ÿæˆ (1å¤©)
5. âš ï¸ å–æ¶ˆç±»å‹ç»†åˆ†å±•ç¤º (0.5å¤©)

**æ€»è®¡å·¥ä½œé‡ï¼šçº¦7.5å¤©**

---

## âœ… å®¡è®¡æŠ¥å‘Šå®Œæˆ

**æŠ¥å‘Šæ’°å†™æ—¶é—´**: 2026-01-08
**å®¡è®¡èŒƒå›´**: å‰ç«¯ç”¨æˆ·ä¸­å¿ƒæ‰€æœ‰é¡µé¢åŠæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
**å‘ç°çœŸæ­£ç¼ºå¤±**: 3ä¸ªP0çº§ + 6ä¸ªP1çº§åŠŸèƒ½
**æ•´ä½“è¯„ä¼°**: é‡æ„ç‰ˆå®Œæˆåº¦86%ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘åŸºæœ¬å®Œæ•´

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: ä¼˜å…ˆå®ŒæˆExcelå¯¼å‡ºã€æ‰¹é‡æ“ä½œã€é¢„å”®å°¾æ¬¾æµç¨‹åå¯è€ƒè™‘ä¸Šçº¿ã€‚
